# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Å–∂–∞—Ç–∏—é –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞

## –û–±–∑–æ—Ä

–ú–µ—Ö–∞–Ω–∏–∑–º –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ - —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∂–∏–º–∞–µ—Ç –¥–ª–∏–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞, —Å–æ–∑–¥–∞–≤–∞—è –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ (summary) —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- üìâ –°–Ω–∏–∑–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ 40-70%
- üí∞ –°—ç–∫–æ–Ω–æ–º–∏—Ç—å –Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ API –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚ö° –£—Å–∫–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤
- üìè –í–µ—Å—Ç–∏ –¥–æ–ª–≥–∏–µ –¥–∏–∞–ª–æ–≥–∏ –±–µ–∑ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ –º–æ–¥–µ–ª–∏

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–°–æ–æ–±—â–µ–Ω–∏–µ 1  ‚îÄ‚îê
–°–æ–æ–±—â–µ–Ω–∏–µ 2  ‚îÄ‚î§
–°–æ–æ–±—â–µ–Ω–∏–µ 3  ‚îÄ‚î§
–°–æ–æ–±—â–µ–Ω–∏–µ 4  ‚îÄ‚îº‚îÄ‚îÄ‚îÄ [–°–£–ú–ú–ê–†–ò–ó–ê–¶–ò–Ø] ‚îÄ‚îÄ> Summary
–°–æ–æ–±—â–µ–Ω–∏–µ 5  ‚îÄ‚î§
–°–æ–æ–±—â–µ–Ω–∏–µ 6  ‚îÄ‚î§
–°–æ–æ–±—â–µ–Ω–∏–µ 7  ‚îÄ‚îò
–°–æ–æ–±—â–µ–Ω–∏–µ 8  ‚îÄ‚îê
–°–æ–æ–±—â–µ–Ω–∏–µ 9  ‚îÄ‚îº‚îÄ‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
–°–æ–æ–±—â–µ–Ω–∏–µ 10 ‚îÄ‚îò

–ò—Ç–æ–≥–æ–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è API:
[Summary] + –°–æ–æ–±—â–µ–Ω–∏—è 8-10
```

### –ê–ª–≥–æ—Ä–∏—Ç–º

1. **–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ**: –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10 —Å–æ–æ–±—â–µ–Ω–∏–π)

2. **–ö–æ–º–ø—Ä–µ—Å—Å–∏—è**: –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞:
   - –ë–µ—Ä—É—Ç—Å—è –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3
   - –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –º–æ–¥–µ–ª–∏ Summarization –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑—é–º–µ
   - –†–µ–∑—é–º–µ –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

3. **–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ**: –ê–≥–µ–Ω—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å —Å–∂–∞—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π

## –ö–ª–∞—Å—Å DialogHistoryManager

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```python
from app import DialogHistoryManager

# –° –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
manager = DialogHistoryManager(compression_threshold=10, use_compression=True)

# –ë–µ–∑ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏
manager = DialogHistoryManager(use_compression=False)
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

#### add_message(role, text)
–î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–ø—Ä–µ—Å—Å–∏—é –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

```python
manager.add_message('user', '–ü—Ä–∏–≤–µ—Ç!')
manager.add_message('assistant', '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!')
```

#### get_history_for_api(use_compressed=None)
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ API.

```python
# –ü–æ–ª—É—á–∏—Ç—å —Å —É—á–µ—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ use_compression
history = manager.get_history_for_api()

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å–∂–∞—Ç—É—é –≤–µ—Ä—Å–∏—é
history = manager.get_history_for_api(use_compressed=True)

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é
history = manager.get_history_for_api(use_compressed=False)
```

#### get_stats()
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏.

```python
stats = manager.get_stats()
print(f"–ö–æ–º–ø—Ä–µ—Å—Å–∏–π: {stats['compression_count']}")
print(f"–°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: {stats['total_tokens_saved']}")
print(f"–°—Ç–µ–ø–µ–Ω—å —Å–∂–∞—Ç–∏—è: {stats['compression_ratio']}%")
```

#### clear()
–û—á–∏—â–∞–µ—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.

```python
manager.clear()
```

## API Endpoint: /compression_test

### –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

#### 1. send - –û–±—ã—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π

```bash
curl -X POST http://localhost:5005/compression_test \
  -H "Content-Type: application/json" \
  -d '{
    "action": "send",
    "message": "–†–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ –æ –∫–æ—Å–º–æ—Å–µ"
  }'
```

–û—Ç–≤–µ—Ç:
```json
{
  "status": "ok",
  "response": "–ö–æ—Å–º–æ—Å - —ç—Ç–æ...",
  "metrics": {
    "response_time": 2.5,
    "input_tokens": 150,
    "output_tokens": 200,
    "total_tokens": 350,
    "cost_rub": 0.0234
  },
  "compression_stats": {
    "total_messages": 3,
    "compressed_messages": 0,
    "compression_count": 0,
    "total_tokens_saved": 0,
    "current_full_tokens": 150,
    "current_compressed_tokens": 150,
    "compression_ratio": 0
  }
}
```

#### 2. compare - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å/–±–µ–∑ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏

```bash
curl -X POST http://localhost:5005/compression_test \
  -H "Content-Type: application/json" \
  -d '{
    "action": "compare",
    "message": "–ß—Ç–æ —Ç–∞–∫–æ–µ —á–µ—Ä–Ω—ã–µ –¥—ã—Ä—ã?"
  }'
```

–û—Ç–≤–µ—Ç:
```json
{
  "status": "ok",
  "comparison": {
    "with_compression": {
      "response": "–ß–µ—Ä–Ω—ã–µ –¥—ã—Ä—ã - —ç—Ç–æ...",
      "metrics": {
        "input_tokens": 120,
        "output_tokens": 180,
        "total_tokens": 300,
        "cost_rub": 0.0216
      }
    },
    "without_compression": {
      "response": "–ß–µ—Ä–Ω—ã–µ –¥—ã—Ä—ã - —ç—Ç–æ...",
      "metrics": {
        "input_tokens": 450,
        "output_tokens": 180,
        "total_tokens": 630,
        "cost_rub": 0.0396
      }
    },
    "savings": {
      "tokens_saved": 330,
      "tokens_saved_percent": 73.33,
      "cost_saved": 0.018,
      "cost_saved_percent": 45.45
    }
  }
}
```

#### 3. stats - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

```bash
curl -X POST http://localhost:5005/compression_test \
  -H "Content-Type: application/json" \
  -d '{"action": "stats"}'
```

#### 4. clear - –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏

```bash
curl -X POST http://localhost:5005/compression_test \
  -H "Content-Type: application/json" \
  -d '{"action": "clear"}'
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞

```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1: –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
python app.py

# –¢–µ—Ä–º–∏–Ω–∞–ª 2: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞
python test_compression.py
```

### –í—ã–≤–æ–¥ —Ç–µ—Å—Ç–∞

```
üî• –¢–ï–°–¢ –ú–ï–•–ê–ù–ò–ó–ú–ê –°–ñ–ê–¢–ò–Ø –ò–°–¢–û–†–ò–ò –î–ò–ê–õ–û–ì–ê (–î–µ–Ω—å 8)
================================================================================

üìù –û—Ç–ø—Ä–∞–≤–∫–∞ 12 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏...

[1/12] –û—Ç–ø—Ä–∞–≤–∫–∞: –ü—Ä–∏–≤–µ—Ç! –†–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ –æ –∫–æ—Å–º–æ—Å–µ....
   ‚è±Ô∏è  –í—Ä–µ–º—è: 2.1s
   üìä –¢–æ–∫–µ–Ω—ã: 15 –≤—Ö–æ–¥ + 95 –≤—ã—Ö–æ–¥ = 110
   üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 0.0012‚ÇΩ

...

[10/12] –û—Ç–ø—Ä–∞–≤–∫–∞: –ß—Ç–æ —Ç–∞–∫–æ–µ –∑–æ–Ω–∞ –æ–±–∏—Ç–∞–µ–º–æ—Å—Ç–∏?...
   ‚è±Ô∏è  –í—Ä–µ–º—è: 2.3s
   üìä –¢–æ–∫–µ–Ω—ã: 280 –≤—Ö–æ–¥ + 120 –≤—ã—Ö–æ–¥ = 400
   üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 0.0256‚ÇΩ
   üóúÔ∏è  –ö–û–ú–ü–†–ï–°–°–ò–Ø: –í—ã–ø–æ–ª–Ω–µ–Ω–æ 1 —Ä–∞–∑(–∞), —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ 450 —Ç–æ–∫–µ–Ω–æ–≤

================================================================================
üìä –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
================================================================================
–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏: 3
–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏: 4
–ö–æ–º–ø—Ä–µ—Å—Å–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: 1
–¢–µ–∫—É—â–∏–µ —Ç–æ–∫–µ–Ω—ã (–ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è): 180
–¢–µ–∫—É—â–∏–µ —Ç–æ–∫–µ–Ω—ã (—Å–∂–∞—Ç–∞—è –∏—Å—Ç–æ—Ä–∏—è): 85
–°—Ç–µ–ø–µ–Ω—å —Å–∂–∞—Ç–∏—è: 52.78%
–í—Å–µ–≥–æ —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: 450

–û–±—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã:
–í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: 3200
–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: 0.2145‚ÇΩ

================================================================================
üî¨ –°–†–ê–í–ù–ò–¢–ï–õ–¨–ù–´–ô –¢–ï–°–¢: –° –ö–û–ú–ü–†–ï–°–°–ò–ï–ô vs –ë–ï–ó –ö–û–ú–ü–†–ï–°–°–ò–ò
================================================================================
–í–æ–ø—Ä–æ—Å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: –ö–∞–∫–∏–µ –µ—Å—Ç—å —Ç–µ–æ—Ä–∏–∏ –æ –±—É–¥—É—â–µ–º –í—Å–µ–ª–µ–Ω–Ω–æ–π?

‚úÖ –° –ö–û–ú–ü–†–ï–°–°–ò–ï–ô:
   üìä –í—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã: 95
   üìä –í—ã—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã: 210
   üìä –í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤: 305
   üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 0.0264‚ÇΩ
   ‚è±Ô∏è  –í—Ä–µ–º—è: 2.8s
   üìù –°–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏: 4
   üìÑ –û—Ç–≤–µ—Ç: –°—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–µ–æ—Ä–∏–π –æ –±—É–¥—É—â–µ–º –í—Å–µ–ª–µ–Ω–Ω–æ–π...

‚ùå –ë–ï–ó –ö–û–ú–ü–†–ï–°–°–ò–ò:
   üìä –í—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã: 520
   üìä –í—ã—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã: 210
   üìä –í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤: 730
   üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 0.046‚ÇΩ
   ‚è±Ô∏è  –í—Ä–µ–º—è: 3.2s
   üìù –°–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏: 12
   üìÑ –û—Ç–≤–µ—Ç: –°—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–µ–æ—Ä–∏–π –æ –±—É–¥—É—â–µ–º –í—Å–µ–ª–µ–Ω–Ω–æ–π...

üí° –≠–ö–û–ù–û–ú–ò–Ø:
   üìä –°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: 425 (81.73%)
   üí∞ –°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ –¥–µ–Ω–µ–≥: 0.0196‚ÇΩ (42.61%)
   ‚è±Ô∏è  –†–∞–∑–Ω–∏—Ü–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏: 0.4s

================================================================================
‚úÖ –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù!
================================================================================
```

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### compression_threshold

–ü–æ—Ä–æ–≥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏:

- **5-7 —Å–æ–æ–±—â–µ–Ω–∏–π**: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –∫–æ–º–ø—Ä–µ—Å—Å–∏—è, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–∞ –ø–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- **10 —Å–æ–æ–±—â–µ–Ω–∏–π** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é): –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —ç–∫–æ–Ω–æ–º–∏–µ–π –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- **15-20 —Å–æ–æ–±—â–µ–Ω–∏–π**: –ú—è–≥–∫–∞—è –∫–æ–º–ø—Ä–µ—Å—Å–∏—è, –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –º–µ–Ω—å—à–∞—è —ç–∫–æ–Ω–æ–º–∏—è

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

–í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è. –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:

```python
# –í –º–µ—Ç–æ–¥–µ _compress_history
messages_to_compress = self.messages[:-3]  # –ò–∑–º–µ–Ω–∏—Ç—å -3 –Ω–∞ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
recent_messages = self.messages[-3:]       # –ò –∑–¥–µ—Å—å —Ç–æ–∂–µ
```

- **1-2 —Å–æ–æ–±—â–µ–Ω–∏—è**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫–æ–º–ø—Ä–µ—Å—Å–∏—è, –Ω–æ –º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è –Ω–µ–¥–∞–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
- **3-4 —Å–æ–æ–±—â–µ–Ω–∏—è** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è): –•–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å
- **5+ —Å–æ–æ–±—â–µ–Ω–∏–π**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–æ–ª—å—à–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –º–µ–Ω—å—à–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–∂–∞—Ç–∏—è

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–ø—Ä–µ—Å—Å–∏—é

‚úÖ **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è**:
- –î–æ–ª–≥–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏ –¥–∏–∞–ª–æ–≥–∏ (>20 —Å–æ–æ–±—â–µ–Ω–∏–π)
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- –û–±—É—á–∞—é—â–∏–µ —Å–µ—Å—Å–∏–∏
- –ò–Ω—Ç–µ—Ä–≤—å—é –∏ –æ–ø—Ä–æ—Å—ã
- –°–∏—Å—Ç–µ–º—ã —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º –±—é–¥–∂–µ—Ç–æ–º

‚ùå **–ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è**:
- –ö–æ—Ä–æ—Ç–∫–∏–µ –¥–∏–∞–ª–æ–≥–∏ (<10 —Å–æ–æ–±—â–µ–Ω–∏–π)
- –ö–æ–≥–¥–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏
- –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
- –ö–æ–≥–¥–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–µ–≤—ã—à–∞–µ—Ç —ç–∫–æ–Ω–æ–º–∏—é

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏:

```python
stats = manager.get_stats()

# –û—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
if stats['compression_ratio'] < 30:
    print("‚ö†Ô∏è –ù–∏–∑–∫–∞—è —Å—Ç–µ–ø–µ–Ω—å —Å–∂–∞—Ç–∏—è - –≤–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–æ–∏—Ç —É–≤–µ–ª–∏—á–∏—Ç—å threshold")
elif stats['compression_ratio'] > 80:
    print("‚ö†Ô∏è –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è —Å—Ç–µ–ø–µ–Ω—å —Å–∂–∞—Ç–∏—è - –≤–æ–∑–º–æ–∂–Ω–∞ –ø–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞")
else:
    print("‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å —Å–∂–∞—Ç–∏—è")
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```python
from app import DialogHistoryManager, call_yandex_gpt

# –°–æ–∑–¥–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä
dialog_manager = DialogHistoryManager(compression_threshold=10)

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –¥–∏–∞–ª–æ–≥–∞
while True:
    user_input = input("–í—ã: ")
    if user_input.lower() in ['exit', 'quit']:
        break

    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    dialog_manager.add_message('user', user_input)

    # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è API
    history = dialog_manager.get_history_for_api()

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    response = call_yandex_gpt(history, temperature=0.7)

    # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
    dialog_manager.add_message('assistant', response)

    print(f"–ê–≥–µ–Ω—Ç: {response}")

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
    if len(dialog_manager.messages) % 5 == 0:
        stats = dialog_manager.get_stats()
        print(f"\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {stats['compression_count']} –∫–æ–º–ø—Ä–µ—Å—Å–∏–π, "
              f"—Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ {stats['total_tokens_saved']} —Ç–æ–∫–µ–Ω–æ–≤\n")
```

### –ü—Ä–∏–º–µ—Ä 2: A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# –°–æ–∑–¥–∞–µ–º –¥–≤–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
manager_a = DialogHistoryManager(use_compression=True)   # –° –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π
manager_b = DialogHistoryManager(use_compression=False)  # –ë–µ–∑ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏

# –¢–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
test_messages = ["–ü—Ä–∏–≤–µ—Ç", "–ö–∞–∫ –¥–µ–ª–∞?", "–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ", ...]

# –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–±–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
for msg in test_messages:
    manager_a.add_message('user', msg)
    manager_b.add_message('user', msg)

    response_a = call_yandex_gpt(manager_a.get_history_for_api())
    response_b = call_yandex_gpt(manager_b.get_history_for_api())

    manager_a.add_message('assistant', response_a)
    manager_b.add_message('assistant', response_b)

# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
stats_a = manager_a.get_stats()
stats_b = manager_b.get_stats()

print(f"–° –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π: {stats_a['current_compressed_tokens']} —Ç–æ–∫–µ–Ω–æ–≤")
print(f"–ë–µ–∑ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏: {stats_b['current_full_tokens']} —Ç–æ–∫–µ–Ω–æ–≤")
print(f"–≠–∫–æ–Ω–æ–º–∏—è: {stats_a['compression_ratio']}%")
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ê–≥–µ–Ω—Ç "–∑–∞–±—ã–≤–∞–µ—Ç" –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

**–†–µ—à–µ–Ω–∏–µ**: –£–≤–µ–ª–∏—á—å—Ç–µ `compression_threshold` –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–∏–∑–∫–∞—è —Å—Ç–µ–ø–µ–Ω—å —Å–∂–∞—Ç–∏—è

**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª–∏–Ω–Ω—ã–µ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏
- –£–º–µ–Ω—å—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –º–æ–¥–µ–ª–∏ Summarization

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ –ø—Ä–∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API Yandex Cloud
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–≤–æ—Ç—ã –∏ –ª–∏–º–∏—Ç—ã
- –ö–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç fallback - –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–µ—Ä–Ω–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ–µ —Ä–µ–∑—é–º–µ

## –ú–µ—Ç—Ä–∏–∫–∏ –∏ KPI

### –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

1. **–°—Ç–µ–ø–µ–Ω—å —Å–∂–∞—Ç–∏—è** (Compression Ratio)
   - –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 40-70%
   - –§–æ—Ä–º—É–ª–∞: `(1 - compressed_tokens / full_tokens) * 100`

2. **–≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤** (Tokens Saved)
   - –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â—É—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

3. **–≠–∫–æ–Ω–æ–º–∏—è —Å—Ä–µ–¥—Å—Ç–≤** (Cost Saved)
   - –í —Ä—É–±–ª—è—Ö
   - –£—á–∏—Ç—ã–≤–∞–µ—Ç –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—é

4. **–ß–∞—Å—Ç–æ—Ç–∞ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏** (Compression Frequency)
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø—Ä–µ—Å—Å–∏–π –Ω–∞ –¥–∏–∞–ª–æ–≥
   - –û–ø—Ç–∏–º–∞–ª—å–Ω–æ: 1-3 –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ –∏–∑ 30+ —Å–æ–æ–±—â–µ–Ω–∏–π

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ú–µ—Ö–∞–Ω–∏–∑–º –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ - —ç—Ç–æ –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å AI-–∞–≥–µ–Ω—Ç–∞–º–∏. –ü—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –æ–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- –°–Ω–∏–∑–∏—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ 40-70%
- –í–µ—Å—Ç–∏ –¥–ª–∏–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- –£—Å–∫–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –≤ —Å–≤–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã!
