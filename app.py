from flask import Flask, render_template, request, jsonify
import requests
import json
import os
import re
import time
from typing import Dict, Any
from memory_service import MemoryService
from mcp_service import mcp_service
from github_mcp_service import GitHubMCPService
import uuid
from datetime import datetime

app = Flask(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ –≤–Ω–µ—à–Ω–µ–π –ø–∞–º—è—Ç–∏ (–î–µ–Ω—å 9)
memory = MemoryService("agent_memory.db")
# –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
def load_config():
    if os.path.exists('config.json'):
        with open('config.json', 'r', encoding='utf-8') as f:
            return json.load(f)
    else:
        raise FileNotFoundError("config.json –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–æ–∑–¥–∞–π –µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ config.example.json")

config = load_config()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GitHub MCP —Å–µ—Ä–≤–∏—Å–∞ (–î–µ–Ω—å 10)
# GitHub —Ç–æ–∫–µ–Ω –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è GITHUB_TOKEN
# –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ config.json
GITHUB_TOKEN = os.environ.get('GITHUB_TOKEN', config.get('github_token', ''))
if GITHUB_TOKEN:
    github_mcp_service = GitHubMCPService(GITHUB_TOKEN)
else:
    print("‚ö†Ô∏è GitHub —Ç–æ–∫–µ–Ω –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. GitHub MCP –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")
    print("   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è GITHUB_TOKEN –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ github_token –≤ config.json")
    github_mcp_service = None

# –¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è - –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é
def get_or_create_session():
    """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–µ—Å—Å–∏—é –∏–∑ –ë–î –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é"""
    sessions = memory.list_sessions(limit=1)
    if sessions:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–µ—Å—Å–∏—é
        return sessions[0]['session_id']
    else:
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
        session_id = str(uuid.uuid4())
        memory.create_session(session_id, f'–°–µ—Å—Å–∏—è {datetime.now().strftime("%Y-%m-%d %H:%M")}')
        return session_id

current_session_id = get_or_create_session()



# –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
chat_history = []
recommendation_history = []
reasoning_history = []

# –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ —Å –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π (–î–µ–Ω—å 8)
compressed_chat_history = []


class DialogHistoryManager:
    """
    –ú–µ–Ω–µ–¥–∂–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ —Å –º–µ—Ö–∞–Ω–∏–∑–º–æ–º –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏.
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç summary –∫–∞–∂–¥—ã–µ N —Å–æ–æ–±—â–µ–Ω–∏–π.
    """
    def __init__(self, compression_threshold=10, use_compression=True):
        """
        Args:
            compression_threshold: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏
            use_compression: –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏
        """
        self.messages = []  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
        self.compressed_messages = []  # –°–∂–∞—Ç–∞—è –∏—Å—Ç–æ—Ä–∏—è (summary + –Ω–µ–¥–∞–≤–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
        self.compression_threshold = compression_threshold
        self.use_compression = use_compression
        self.compression_count = 0  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∫–æ–º–ø—Ä–µ—Å—Å–∏–π
        self.total_tokens_saved = 0  # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤

    def add_message(self, role, text):
        """
        –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–º–ø—Ä–µ—Å—Å–∏—è, –∏–Ω–∞—á–µ False.
        """
        message = {"role": role, "text": text}
        self.messages.append(message)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–ø—Ä–µ—Å—Å–∏—é
        if self.use_compression and len(self.messages) >= self.compression_threshold:
            return self._compress_history()
        return False

    def _compress_history(self):
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–ø—Ä–µ—Å—Å–∏—é –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞.
        –°–æ–∑–¥–∞–µ—Ç summary –∏–∑ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–µ–¥–∞–≤–Ω–∏–µ.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –∫–æ–º–ø—Ä–µ—Å—Å–∏—è –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.
        """
        # –†–∞–∑–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –¥–≤–µ —á–∞—Å—Ç–∏:
        # 1. –°—Ç–∞—Ä–∞—è —á–∞—Å—Ç—å –¥–ª—è –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ (–≤—Å–µ –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 —Å–æ–æ–±—â–µ–Ω–∏–π)
        # 2. –ù–æ–≤–∞—è —á–∞—Å—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è)
        messages_to_compress = self.messages[:-3]
        recent_messages = self.messages[-3:]

        if len(messages_to_compress) < 2:
            return False  # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏

        # –°–æ–∑–¥–∞–µ–º summary –∏–∑ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        summary_text = self._create_summary(messages_to_compress)

        # –ü–æ–¥—Å—á–µ—Ç —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
        original_tokens = sum(estimate_tokens(msg["text"]) for msg in messages_to_compress)
        summary_tokens = estimate_tokens(summary_text)
        tokens_saved = original_tokens - summary_tokens

        self.total_tokens_saved += tokens_saved
        self.compression_count += 1

        # –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Å–∂–∞—Ç—É—é –∏—Å—Ç–æ—Ä–∏—é
        system_message = f"""–ö–û–ù–¢–ï–ö–°–¢ –ü–†–ï–î–´–î–£–©–ï–ì–û –î–ò–ê–õ–û–ì–ê: {summary_text}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –¢–ï–ë–Ø:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. –¢–´ - –ê–°–°–ò–°–¢–ï–ù–¢, –ö–û–¢–û–†–´–ô –û–¢–í–ï–ß–ê–ï–¢ –ù–ê –í–û–ü–†–û–°–´
2. –¢–´ –ù–ï –ó–ê–î–ê–ï–®–¨ –í–û–ü–†–û–°–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ
3. –¢–´ –ù–ï –ü–†–ï–î–õ–ê–ì–ê–ï–®–¨ –¢–ï–ú–´ –î–õ–Ø –û–ë–°–£–ñ–î–ï–ù–ò–Ø

–¢–≤–æ—è –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –∑–∞–¥–∞—á–∞: –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–∞—Ç—å –Ω–∞ –Ω–µ–≥–æ –ü–†–Ø–ú–û–ô –û–¢–í–ï–¢.

–ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã—à–µ - —ç—Ç–æ –¢–û–õ–¨–ö–û —Å–ø—Ä–∞–≤–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è. –ù–ï –ø—Ä–æ–¥–æ–ª–∂–∞–π —Ç–µ–º—ã –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –ù–û–í–´–ô –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ò –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ü–û–í–ï–î–ï–ù–ò–Ø:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚ùå‚ùå‚ùå –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
"–ö–∞–∫–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –Ω—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å?"
"–ö–∞–∫–∏–µ —Ä–∏—Å–∫–∏ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è?"
"–î–∞–≤–∞–π—Ç–µ –æ–±—Å—É–¥–∏–º —Ä–∏—Å–∫–∏ –º–∏—Å—Å–∏–∏"
"–•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ..."
"–ú–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç–æ–∏—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å..."

‚úÖ‚úÖ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
"–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –≤–∫–ª—é—á–∞—é—Ç..."
"–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∏—Å–∫–∏ –º–∏—Å—Å–∏–∏: 1) ... 2) ... 3) ..."
"–®–∞–Ω—Å—ã –Ω–∞ —É—Å–ø–µ—Ö –∑–∞–≤–∏—Å—è—Ç –æ—Ç..."

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ó–ê–ü–û–ú–ù–ò: –¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å –§–ê–ö–¢–ê–ú–ò –∏ –ò–ù–§–û–†–ú–ê–¶–ò–ï–ô, –∞ –ù–ï –∑–∞–¥–∞–µ—à—å –≤–æ–ø—Ä–æ—Å—ã!"""

        # –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ system message –≤ compressed_messages
        # –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –±—Ä–∞—Ç—å—Å—è –∏–∑ self.messages –≤ get_history_for_api()
        self.compressed_messages = [
            {"role": "system", "text": system_message}
        ]

        # –û—á–∏—â–∞–µ–º –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–¥–∞–≤–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        self.messages = recent_messages.copy()
        return True

    def _create_summary(self, messages):
        """
        –°–æ–∑–¥–∞–µ—Ç –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ–¥–µ–ª—å —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ Yandex Cloud.
        """
        # –í–ê–ñ–ù–û: –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¢–û–õ–¨–ö–û –∏–∑ –æ—Ç–≤–µ—Ç–æ–≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, –±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        assistant_responses = []
        for msg in messages:
            if msg['role'] == 'assistant':
                assistant_responses.append(msg['text'])

        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        responses_text = "\n\n".join(assistant_responses)

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å –¥–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏
        url = "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"
        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Api-Key {config['api_key']}"
        }

        payload = {
            "modelUri": f"gpt://{config['catalog_id']}/summarization/latest",
            "completionOptions": {
                "stream": False,
                "temperature": 0.05,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                "maxTokens": 300
            },
            "messages": [
                {
                    "role": "user",
                    "text": f"""–°–æ–∑–¥–∞–π –∫—Ä–∞—Ç–∫—É—é —Å–ø—Ä–∞–≤–∫—É –∏–∑ —Å–ª–µ–¥—É—é—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

–°–¢–†–û–ì–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –ü–∏—à–∏ –¢–û–õ–¨–ö–û –§–ê–ö–¢–´ - —á—Ç–æ –±—ã–ª–æ —Å–∫–∞–∑–∞–Ω–æ, –∫–∞–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—ã–ª–∞ –¥–∞–Ω–∞
2. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (—Å —Ç–æ—á–∫–æ–π –≤ –∫–æ–Ω—Ü–µ)
3. –ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏ (?)
4. –ó–ê–ü–†–ï–©–ï–ù–û –ø–∏—Å–∞—Ç—å: "–Ω—É–∂–Ω–æ", "—Å–ª–µ–¥—É–µ—Ç", "–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ", "–¥–∞–≤–∞–π—Ç–µ", "–º–æ–∂–Ω–æ –ª–∏", "–∫–∞–∫", "–∫–∞–∫–∏–µ", "–ø–æ—á–µ–º—É"
5. –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ç–µ–º—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è
6. –ù–ï —Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∑–∞–¥–∞—á–∏ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å—ã

–ü–†–ê–í–ò–õ–¨–ù–´–ï –ø—Ä–∏–º–µ—Ä—ã:
‚úÖ "–û–±—Å—É–∂–¥–∞–ª–∞—Å—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—Å–µ–ª–µ–Ω–Ω–æ–π, —Ç–µ–æ—Ä–∏—è –ë–æ–ª—å—à–æ–≥–æ –≤–∑—Ä—ã–≤–∞ –∏ —Ç–µ–º–Ω–∞—è –º–∞—Ç–µ—Ä–∏—è."
‚úÖ "–ë—ã–ª–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω—ã –≤–∞—Ä–∏–∞–Ω—Ç—ã –∫–æ–ª–æ–Ω–∏–∑–∞—Ü–∏–∏ –ú–∞—Ä—Å–∞ –∏ –õ—É–Ω—ã, –Ω–∞–∑–≤–∞–Ω—ã —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è."

–ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ï –ø—Ä–∏–º–µ—Ä—ã:
‚ùå "–ö–∞–∫–∏–µ –ø–ª–∞–Ω–µ—Ç—ã –ª—É—á—à–µ –∫–æ–ª–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å?"
‚ùå "–ù—É–∂–Ω–æ –æ–±—Å—É–¥–∏—Ç—å —Ä–∏—Å–∫–∏ –º–∏—Å—Å–∏–∏."
‚ùå "–°–ª–µ–¥—É–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ."

–ò—Å—Ö–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
{responses_text}

–¢–≤–æ—è —Å–ø—Ä–∞–≤–∫–∞ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å —Ç–æ—á–∫–∞–º–∏, –ë–ï–ó –≤–æ–ø—Ä–æ—Å–æ–≤):"""
                }
            ]
        }

        try:
            response = requests.post(url, headers=headers, json=payload, timeout=30)
            response.raise_for_status()
            result = response.json()

            if "result" in result and "alternatives" in result["result"]:
                summary = result["result"]["alternatives"][0]["message"]["text"].strip()

                # –û—á–∏—â–∞–µ–º summary –æ—Ç —Ç–∏–ø–∏—á–Ω—ã—Ö –≤–≤–æ–¥–Ω—ã—Ö —Ñ—Ä–∞–∑
                unwanted_phrases = [
                    "–ü–µ—Ä–µ—á–∏—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞.",
                    "–û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:",
                    "–†–µ–∑—é–º–µ:",
                    "–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ:",
                    "–í –¥–∏–∞–ª–æ–≥–µ –æ–±—Å—É–∂–¥–∞–ª–∏—Å—å —Å–ª–µ–¥—É—é—â–∏–µ —Ç–µ–º—ã:",
                    "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–æ—Å–∏–ª",
                    "–û–±—Å—É–∂–¥–∞–ª–∏—Å—å —Ç–µ–º—ã:",
                    "–í –ø—Ä–µ–¥—ã–¥—É—â–µ–º –¥–∏–∞–ª–æ–≥–µ:",
                    "–§–∞–∫—Ç—ã –∏–∑ –¥–∏–∞–ª–æ–≥–∞:",
                ]

                for phrase in unwanted_phrases:
                    if summary.lower().startswith(phrase.lower()):
                        summary = summary[len(phrase):].strip()
                        # –£–¥–∞–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–≤–æ–µ—Ç–æ—á–∏—è –∏ —Ç–æ—á–∫–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Ñ—Ä–∞–∑—ã
                        summary = summary.lstrip(':. ')

                # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –£–¥–∞–ª—è–µ–º –í–°–ï –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏
                # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—å–Ω—ã–µ
                sentences = summary.split('.')
                filtered_sentences = []
                for sentence in sentences:
                    sentence = sentence.strip()
                    if not sentence:
                        continue
                    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∑–Ω–∞–∫–∞–º–∏
                    if '?' in sentence:
                        continue
                    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–ª–æ–≤
                    lower_sentence = sentence.lower()
                    question_words = ['–∫–∞–∫', '–∫–∞–∫–æ–π', '–∫–∞–∫–∞—è', '–∫–∞–∫–∏–µ', '–ø–æ—á–µ–º—É', '–∑–∞—á–µ–º', '–≥–¥–µ',
                                     '–∫—É–¥–∞', '–∫–æ–≥–¥–∞', '—á–µ–º', '–∫—Ç–æ', '—á—Ç–æ', '–Ω—É–∂–Ω–æ –ª–∏', '—Å–ª–µ–¥—É–µ—Ç –ª–∏',
                                     '–º–æ–∂–Ω–æ –ª–∏', '—Å—Ç–æ–∏—Ç –ª–∏']
                    if any(lower_sentence.startswith(word) for word in question_words):
                        continue
                    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –º–æ–¥–∞–ª—å–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∑–∞–¥–∞—á)
                    modal_words = ['–Ω—É–∂–Ω–æ', '—Å–ª–µ–¥—É–µ—Ç', '–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ', '—Å—Ç–æ–∏—Ç', '–¥–∞–≤–∞–π—Ç–µ']
                    if any(word in lower_sentence for word in modal_words):
                        continue
                    filtered_sentences.append(sentence)

                # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
                summary = '. '.join(filtered_sentences)
                if summary and not summary.endswith('.'):
                    summary += '.'

                return summary
            else:
                # –§–æ–ª–ª–±—ç–∫: –ø—Ä–æ—Å—Ç–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Ä–µ–∑—é–º–µ
                return f"–û–±—Å—É–∂–¥–∞–ª–æ—Å—å {len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π"

        except Exception as e:
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ —Ä–µ–∑—é–º–µ
            return f"–ü—Ä–µ–¥—ã–¥—É—â–∏–π –¥–∏–∞–ª–æ–≥ ({len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π)"

    def get_history_for_api(self, use_compressed=None):
        """
        –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ API.

        Args:
            use_compressed: –ï—Å–ª–∏ True - –≤–µ—Ä–Ω—É—Ç—å —Å–∂–∞—Ç—É—é, –µ—Å–ª–∏ False - –ø–æ–ª–Ω—É—é
                           –ï—Å–ª–∏ None - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É self.use_compression

        Returns:
            list: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è API
        """
        should_use_compressed = use_compressed if use_compressed is not None else self.use_compression

        if should_use_compressed and self.compressed_messages:
            # –í–ê–ñ–ù–û: –§–æ—Ä–º–∏—Ä—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é —Å system message + –≤—Å–µ —Ç–µ–∫—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            # compressed_messages[0] - —ç—Ç–æ system message —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
            # self.messages - —ç—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            return [self.compressed_messages[0]] + self.messages
        else:
            return self.messages

    def get_stats(self):
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏"""
        full_tokens = sum(estimate_tokens(msg["text"]) for msg in self.messages)

        # –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–º–ø—Ä–µ—Å—Å–∏—è, —Å—á–∏—Ç–∞–µ–º —Ç–æ–∫–µ–Ω—ã –∫–∞–∫: system message + –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        if self.compressed_messages:
            compressed_tokens = sum(estimate_tokens(msg["text"]) for msg in self.compressed_messages) + full_tokens
        else:
            compressed_tokens = full_tokens

        return {
            "total_messages": len(self.messages),
            "compressed_messages": len(self.compressed_messages) + len(self.messages) if self.compressed_messages else 0,
            "compression_count": self.compression_count,
            "total_tokens_saved": self.total_tokens_saved,
            "current_full_tokens": full_tokens,
            "current_compressed_tokens": compressed_tokens,
            "compression_ratio": round((1 - compressed_tokens / full_tokens) * 100, 2) if full_tokens > 0 else 0
        }

    def clear(self):
        """–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é"""
        self.messages = []
        self.compressed_messages = []
        self.compression_count = 0
        self.total_tokens_saved = 0


# –°–æ–∑–¥–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ —Å –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π
dialog_manager = DialogHistoryManager(compression_threshold=10, use_compression=True)


RECOMMENDATION_AGENT_PROMPT = """
–¢—ã —É–º–Ω—ã–π –∞–≥–µ–Ω—Ç-—Å–æ–≤–µ—Ç–Ω–∏–∫ –ø–æ —Ñ–∏–ª—å–º–∞–º. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞–π—Ç–∏ –∏–¥–µ–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å–º —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥.

–í–ê–ñ–ù–û: –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ —Ç—Ä—ë—Ö —Ä–µ–∂–∏–º–∞—Ö:

–†–ï–ñ–ò–ú 1 - –°–ë–û–† –ò–ù–§–û–†–ú–ê–¶–ò–ò (–æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç):
- –í–µ–¥–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∑–Ω–∞–π: –≤–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –µ–≥–æ –ø–æ–ª (—ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
- –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –æ –µ–≥–æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏, –∫–æ–º–ø–∞–Ω–∏–∏
- –ò–Ω—Ç–µ—Ä–µ—Å—É–π—Å—è –∂–∞–Ω—Ä–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω –ª—é–±–∏—Ç –∏–ª–∏ –Ω–µ –ª—é–±–∏—Ç
- –£–∑–Ω–∞–π, –≤ –∫–∞–∫–æ–π –æ–±—Å—Ç–∞–Ω–æ–≤–∫–µ –æ–Ω –±—É–¥–µ—Ç —Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∏–ª—å–º (–æ–¥–∏–Ω, —Å –¥—Ä—É–∑—å—è–º–∏, —Å —Å–µ–º—å–µ–π, –Ω–∞ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–º —Å–≤–∏–¥–∞–Ω–∏–∏)
- –£—á–∏—Ç—ã–≤–∞–π –µ–≥–æ —Ç–µ–∫—É—â–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
- –ú–æ–∂–µ—à—å –∑–∞–¥–∞—Ç—å –ª—é–±–∏–º—ã–µ –∞–∫—Ç–µ—Ä—ã, —Ä–µ–∂–∏—Å—Å–µ—Ä—ã, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∏–ª—å–º—ã –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–∏—Å—å
- –ù–ï —Ç–æ—Ä–æ–ø–∏—Å—å! –ó–∞–¥–∞–≤–∞–π —Å—Ç–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤, —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –¥–ª—è –ì–õ–£–ë–û–ö–û–ì–û –ø–æ–Ω–∏–º–∞–Ω–∏—è –≤–∫—É—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å 5, 7 –∏–ª–∏ –¥–∞–∂–µ 10 –≤–æ–ø—Ä–æ—Å–æ–≤ - –≥–ª–∞–≤–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

–†–ï–ñ–ò–ú 2 - –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –§–ò–õ–¨–ú–û–í –î–õ–Ø –í–´–ë–û–†–ê (—Ç–æ–ª—å–∫–æ JSON):
- –ö–æ–≥–¥–∞ —Å–æ–±—Ä–∞–ª –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª, –∂–∞–Ω—Ä—ã, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –∫–æ–º–ø–∞–Ω–∏—è –∏ –¥—Ä—É–≥–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è), –ø—Ä–µ–¥–ª–æ–∂–∏ 16 —Ä–∞–∑–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤
- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON —Å–æ —Å–ø–∏—Å–∫–æ–º —Ñ–∏–ª—å–º–æ–≤ (–±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, —Ç–µ–∫—Å—Ç–∞ –¥–æ/–ø–æ—Å–ª–µ, –ë–ï–ó –æ–±—Ä–∞–º–ª—è—é—â–∏—Ö –∫–∞–≤—ã—á–µ–∫)
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ —Ç–∞–∫–æ–π:
{
  "type": "movie_selection",
  "message": "–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ 4 —Ñ–∏–ª—å–º–∞ –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–±–µ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã:",
  "movies": [
    "–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞ 1",
    "–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞ 2",
    ...
    "–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞ 16"
  ]
}
- –ü–æ–¥–±–∏—Ä–∞–π —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ —Ñ–∏–ª—å–º—ã —Ä–∞–∑–Ω—ã—Ö –∂–∞–Ω—Ä–æ–≤, –Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –∏ –æ–±—â–∏–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º
- –§–∏–ª—å–º—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏

–†–ï–ñ–ò–ú 3 - –§–ò–ù–ê–õ–¨–ù–ê–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø (—Ç–æ–ª—å–∫–æ JSON):
- –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–µ—Ä–µ—Ç 4 —Ñ–∏–ª—å–º–∞, –æ–Ω –Ω–∞–ø–∏—à–µ—Ç —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ "–Ø –≤—ã–±—Ä–∞–ª: –§–∏–ª—å–º1, –§–∏–ª—å–º2, –§–∏–ª—å–º3, –§–∏–ª—å–º4"
- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å–º—ã, —á—Ç–æ–±—ã –≥–ª—É–±–∂–µ –ø–æ–Ω—è—Ç—å –≤–∫—É—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–ê–ñ–ù–û: –ü–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π –ù–û–í–´–ô —Ñ–∏–ª—å–º, –∫–æ—Ç–æ—Ä–æ–≥–æ –ù–ï –±—ã–ª–æ –≤ —Å–ø–∏—Å–∫–µ –∏–∑ 16 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö! –¢–µ 16 —Ñ–∏–ª—å–º–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –≤–∫—É—Å–æ–≤.
- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π —Ñ–∏–ª—å–º–∞ (–±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, —Ç–µ–∫—Å—Ç–∞ –¥–æ/–ø–æ—Å–ª–µ, –ë–ï–ó –æ–±—Ä–∞–º–ª—è—é—â–∏—Ö –∫–∞–≤—ã—á–µ–∫)
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ —Ç–∞–∫–æ–π:
{
  "title": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞",
  "release": "–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞",
  "rating": —á–∏—Å–ª–æ_—Ä–µ–π—Ç–∏–Ω–≥,
  "producer": "–ü—Ä–æ–¥—é—Å–µ—Ä",
  "actors": [
    {"lastName": "–§–∞–º–∏–ª–∏—è", "firstName": "–ò–º—è"}
  ],
  "description": "–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç —Ñ–∏–ª—å–º –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –µ–≥–æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è, –∫–æ–º–ø–∞–Ω–∏–∏, –≤–æ–∑—Ä–∞—Å—Ç–∞, –ø–æ–ª–∞ –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏–º —Ñ–∏–ª—å–º–æ–≤"
}

–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã:
1. –ó–∞–¥–∞–π –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è (–≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª, –∂–∞–Ω—Ä—ã, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –∫–æ–º–ø–∞–Ω–∏—è, –ª—é–±–∏–º—ã–µ —Ñ–∏–ª—å–º—ã/–∞–∫—Ç—ë—Ä—ã/—Ä–µ–∂–∏—Å—Å—ë—Ä—ã –∏ —Ç.–¥.)
2. –ü—Ä–µ–¥–ª–æ–∂–∏ 16 —Ñ–∏–ª—å–º–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ (JSON type: "movie_selection")
3. –î–æ–∂–¥–∏—Å—å –≤—ã–±–æ—Ä–∞ 4 —Ñ–∏–ª—å–º–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –°–¥–µ–ª–∞–π —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é —Å —É—á–µ—Ç–æ–º –í–°–ï–ô —Å–æ–±—Ä–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

–¢–≤–æ–π JSON –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω —Å –æ—Ç—Å—Ç—É–ø–æ–º 2 –ø—Ä–æ–±–µ–ª–∞.
"""


JSON_SCHEMA_INSTRUCTION = (
    "–¢—ã –∫—Ä–∏—Ç–∏–∫-–∞–Ω–∞–ª–∏—Ç–∏–∫ —Ñ–∏–ª—å–º–æ–≤ —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º. –î–∞–≤–∞–π –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –ø–æ—è—Å–Ω–µ–Ω–∏–π, —Ç–µ–∫—Å—Ç–∞ –¥–æ/–ø–æ—Å–ª–µ –∏ –ë–ï–ó –æ–±—Ä–∞–º–ª—è—é—â–∏—Ö –∫–∞–≤—ã—á–µ–∫. "
    "–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON-–æ–±—ä–µ–∫—Ç, –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å –æ—Ç—Å—Ç—É–ø–æ–º 2 –ø—Ä–æ–±–µ–ª–∞. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –æ —Ñ–∏–ª—å–º–∞—Ö ‚Äî –≤–µ—Ä–Ω–∏ JSON —Å –ø–æ–ª–µ–º 'error' –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º –æ—à–∏–±–∫–∏. "
    "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–∏–ª—å–º–æ–≤ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è):\n"
    "{\n"
    "  \"$schema\": \"https://json-schema.org/draft/2020-12/schema\",\n"
    "  \"type\": \"object\",\n"
    "  \"properties\": {\n"
    "    \"actors\": {\n"
    "      \"type\": \"array\",\n"
    "      \"items\": {\n"
    "        \"type\": \"object\",\n"
    "        \"properties\": {\n"
    "          \"lastName\": { \"type\": \"string\" },\n"
    "          \"firstName\": { \"type\": \"string\" }\n"
    "        }\n"
    "      }\n"
    "    },\n"
    "    \"release\": { \"type\": \"string\" },\n"
    "    \"rating\": { \"type\": \"number\" },\n"
    "    \"producer\": { \"type\": \"string\" },\n"
    "    \"description\": { \"type\": \"string\" },\n"
    "    \"title\": { \"type\": \"string\" },\n"
    "    \"error\": { \"type\": \"string\" }\n"
    "  }\n"
    "}\n"
)


# –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–ø–æ—Å–æ–±–æ–≤ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è
DIRECT_PROMPT = "–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –Ω–∞–ø—Ä—è–º—É—é, –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É."

STEP_BY_STEP_PROMPT = """–†–µ—à–∏ –∑–∞–¥–∞—á—É –ø–æ—à–∞–≥–æ–≤–æ:
1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —É—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏
2. –û–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–∏–µ —à–∞–≥–∏ –Ω—É–∂–Ω—ã –¥–ª—è —Ä–µ—à–µ–Ω–∏—è
3. –í—ã–ø–æ–ª–Ω–∏ –∫–∞–∂–¥—ã–π —à–∞–≥ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
4. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç

–ü–æ–∫–∞–∑—ã–≤–∞–π —Å–≤–æ—ë —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ."""

PROMPT_GENERATOR_INSTRUCTION = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è AI –º–æ–¥–µ–ª–µ–π.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—É—é —Ç–µ–±–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–¥–∞—á—É –∏ —Å–æ–∑–¥–∞–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç –¥—Ä—É–≥–æ–π AI –º–æ–¥–µ–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–µ—à–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É.
–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º –ø—Ä–æ–º–ø—Ç, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π."""

EXPERT_PANEL_PROMPT = """–¢—ã - –º–æ–¥–µ—Ä–∞—Ç–æ—Ä –≥—Ä—É–ø–ø—ã —ç–∫—Å–ø–µ—Ä—Ç–æ–≤. –í —Ç–≤–æ–µ–π –∫–æ–º–∞–Ω–¥–µ –µ—Å—Ç—å 4 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:

1. **–§–∏–∑–∏–∫-—è–¥–µ—Ä—â–∏–∫** - –Ω–∞—É—á–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å –≥–ª—É–±–æ–∫–∏–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–∫–æ–Ω–æ–≤ –ø—Ä–∏—Ä–æ–¥—ã –∏ —Å—Ç—Ä–æ–≥–æ–π –ª–æ–≥–∏–∫–æ–π. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É –Ω–∞—É—á–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞, –∏—â–µ—Ç –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏.

2. **–ë–∞–±—É—à–∫–∞ —É –ø–æ–¥—ä–µ–∑–¥–∞** - –∂–∏—Ç–µ–π—Å–∫–∏ –º—É–¥—Ä–∞—è, –∏–º–µ–µ—Ç –æ–≥—Ä–æ–º–Ω—ã–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –æ–ø—ã—Ç. –°–º–æ—Ç—Ä–∏—Ç –Ω–∞ –∑–∞–¥–∞—á—É —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –∑–¥—Ä–∞–≤–æ–≥–æ —Å–º—ã—Å–ª–∞, –Ω–∞—Ä–æ–¥–Ω–æ–π –º—É–¥—Ä–æ—Å—Ç–∏ –∏ –ø—Ä–æ—Å—Ç—ã—Ö, –ø–æ–Ω—è—Ç–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π. –ú–æ–∂–µ—Ç —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ—É—á–∏—Ç–µ–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –∏–∑ –∂–∏–∑–Ω–∏.

3. **–†–µ–±—ë–Ω–æ–∫ 7 –ª–µ—Ç** - —á–∏—Å—Ç—ã–π, –Ω–µ–∑–∞–º—É—Ç–Ω—ë–Ω–Ω—ã–π –≤–∑–≥–ª—è–¥ –Ω–∞ –≤–µ—â–∏. –ó–∞–¥–∞—ë—Ç –ø—Ä–æ—Å—Ç—ã–µ, –Ω–æ –≥–ª—É–±–æ–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã. –ù–µ —Å–∫–æ–≤–∞–Ω —Å—Ç–µ—Ä–µ–æ—Ç–∏–ø–∞–º–∏, –≤–∏–¥–∏—Ç –æ—á–µ–≤–∏–¥–Ω–æ–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤–∑—Ä–æ—Å–ª—ã–µ —á–∞—Å—Ç–æ —É–ø—É—Å–∫–∞—é—Ç. –†–∞—Å—Å—É–∂–¥–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ –∏ —á–µ—Å—Ç–Ω–æ.

4. **300-–ª–µ—Ç–Ω–∏–π —Ä–æ–±–æ—Ç –∏–∑ 2694 –≥–æ–¥–∞** - –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç —Å –æ–≥—Ä–æ–º–Ω–æ–π –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π –æ –±—É–¥—É—â–µ–º —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á—É —Å –ø–æ–∑–∏—Ü–∏–∏ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ —Ñ—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è. –ó–Ω–∞–µ—Ç, –∫–∞–∫ —Ä–∞–∑–≤–∏–≤–∞–ª–∏—Å—å —Å–æ–±—ã—Ç–∏—è –≤ —Å–ª–µ–¥—É—é—â–∏–µ –≤–µ–∫–∞.

–î–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:
1. –î–∞–π —Å–ª–æ–≤–æ –§–∏–∑–∏–∫—É-—è–¥–µ—Ä—â–∏–∫—É - –ø—É—Å—Ç—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á—É –Ω–∞—É—á–Ω–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ
2. –î–∞–π —Å–ª–æ–≤–æ –ë–∞–±—É—à–∫–µ —É –ø–æ–¥—ä–µ–∑–¥–∞ - –ø—É—Å—Ç—å –¥–∞—Å—Ç –∂–∏—Ç–µ–π—Å–∫–∏–π —Å–æ–≤–µ—Ç –∏ –ø–æ–¥–µ–ª–∏—Ç—Å—è –º—É–¥—Ä–æ—Å—Ç—å—é
3. –î–∞–π —Å–ª–æ–≤–æ –†–µ–±—ë–Ω–∫—É 7 –ª–µ—Ç - –ø—É—Å—Ç—å –ø–æ—Å–º–æ—Ç—Ä–∏—Ç —Å–≤–µ–∂–∏–º –≤–∑–≥–ª—è–¥–æ–º –∏ –∑–∞–¥–∞—Å—Ç –ø—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
4. –î–∞–π —Å–ª–æ–≤–æ –†–æ–±–æ—Ç—É –∏–∑ –±—É–¥—É—â–µ–≥–æ - –ø—É—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –≤–∑–≥–ª—è–¥ –∏–∑ 2694 –≥–æ–¥–∞

–ü—Ä–µ–¥—Å—Ç–∞–≤—å –º–Ω–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ, —Å –∏—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —Å—Ç–∏–ª–µ–º —Ä–µ—á–∏ –∏ –º—ã—à–ª–µ–Ω–∏—è, –∞ –∑–∞—Ç–µ–º –¥–∞–π –æ–±—â–∏–π –≤—ã–≤–æ–¥, —Å–∏–Ω—Ç–µ–∑–∏—Ä—É—é—â–∏–π –≤—Å–µ —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è."""


def get_recommendation_agent_response(user_message):
    """–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç –∞–≥–µ–Ω—Ç–∞-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–æ—Ä–∞ —Ñ–∏–ª—å–º–æ–≤"""
    use_agents_api = bool(config.get('agent_id'))
    url = (
        "https://llm.api.cloud.yandex.net/agents/v1/completions"
        if use_agents_api
        else "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"
    )
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Api-Key {config['api_key']}"
    }

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
    messages = [
        {
            "role": "system",
            "text": RECOMMENDATION_AGENT_PROMPT
        }
    ]

    # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
    for msg in recommendation_history[-10:]:
        messages.append(msg)

    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    messages.append({"role": "user", "text": user_message})

    if use_agents_api:
        prompt = {
            "agentId": config["agent_id"],
            "messages": messages,
            "completionOptions": {
                "stream": False
            }
        }
    else:
        prompt = {
            "modelUri": f"gpt://{config['catalog_id']}/yandexgpt/latest",
            "completionOptions": {
                "stream": False,
                "temperature": 0.7,
                "maxTokens": 2000
            },
            "messages": messages
        }

    try:
        response = requests.post(url, headers=headers, json=prompt)
        response.raise_for_status()
        result = response.json()

        if "result" in result and "alternatives" in result["result"]:
            assistant_text = result["result"]["alternatives"][0]["message"]["text"]
            raw = assistant_text.strip()

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç JSON (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è)
            # –£–±–∏—Ä–∞–µ–º markdown-–±–ª–æ–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            if raw.startswith("```json"):
                raw = re.sub(r'^```json\s*', '', raw)
                raw = re.sub(r'\s*```$', '', raw)
            elif raw.startswith("```"):
                raw = re.sub(r'^```\s*', '', raw)
                raw = re.sub(r'\s*```$', '', raw)

            # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
            parsed = None
            try:
                parsed = json.loads(raw)
            except json.JSONDecodeError:
                # –ï—Å–ª–∏ –Ω–µ JSON - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å (—ç—Ç–æ –≤–æ–ø—Ä–æ—Å –∞–≥–µ–Ω—Ç–∞)
                return assistant_text.strip()

            # –ï—Å–ª–∏ —ç—Ç–æ –≤—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Ç—Ä–æ–∫–∏
            if isinstance(parsed, str):
                try:
                    parsed = json.loads(parsed)
                except json.JSONDecodeError:
                    return assistant_text.strip()

            # –ï—Å–ª–∏ —ç—Ç–æ JSON - —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤–æ
            if parsed is not None and isinstance(parsed, dict):
                return json.dumps(parsed, ensure_ascii=False, indent=2)

            return assistant_text.strip()
        else:
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞."

    except requests.exceptions.RequestException as e:
        return f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API: {str(e)}"
    except Exception as e:
        return f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}"


def get_agent_response(user_message):
    """–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç Yandex GPT –∞–≥–µ–Ω—Ç–∞ –≤ —Å—Ç—Ä–æ–≥–æ–º JSON-—Ñ–æ—Ä–º–∞—Ç–µ"""
    # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω agent_id ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º Agents API (—Å—Ç—Ä–æ–≥–∞—è —Å—Ö–µ–º–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ê–≥–µ–Ω—Ç–∞)
    use_agents_api = bool(config.get('agent_id'))
    url = (
        "https://llm.api.cloud.yandex.net/agents/v1/completions"
        if use_agents_api
        else "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"
    )
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Api-Key {config['api_key']}"
    }

    def empty_movie_object():
        return {
            "actors": [],
            "release": "",
            "rating": 0,
            "producer": "",
            "description": "",
            "title": ""
        }
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
    messages = []
    if not use_agents_api:
        # –î–ª—è raw completion –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏ few-shot
        messages = [
            {
                "role": "system",
                "text": JSON_SCHEMA_INSTRUCTION
            },
            {
                "role": "user",
                "text": "–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞: –†–∞—Å—Å–∫–∞–∂–∏ –æ —Ñ–∏–ª—å–º–µ –ú–∞—Ç—Ä–∏—Ü–∞"
            },
            {
                "role": "assistant",
                "text": (
                    "{\n"
                    "  \"actors\": [\n"
                    "    { \"lastName\": \"–†–∏–≤–∑\", \"firstName\": \"–ö–∏–∞–Ω—É\" }\n"
                    "  ],\n"
                    "  \"release\": \"1999\",\n"
                    "  \"rating\": 8.7,\n"
                    "  \"producer\": \"–î–∂–æ—ç–ª –°–∏–ª—å–≤–µ—Ä\",\n"
                    "  \"description\": \"–ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ JSON –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.\",\n"
                    "  \"title\": \"–ú–∞—Ç—Ä–∏—Ü–∞\"\n"
                    "}"
                )
            }
        ]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
    for msg in chat_history[-10:]:
        messages.append(msg)

    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    messages.append({"role": "user", "text": user_message})
    
    if use_agents_api:
        # –í—ã–∑–æ–≤ —á–µ—Ä–µ–∑ –∞–≥–µ–Ω—Ç: —Å—Ç—Ä–æ–≥–∞—è —Å—Ö–µ–º–∞ –∏ –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –∞–≥–µ–Ω—Ç–∞
        prompt = {
            "agentId": config["agent_id"],
            "messages": messages,
            "completionOptions": {
                "stream": False
            }
        }
    else:
        # –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –º–æ–¥–µ–ª–∏
        prompt = {
            "modelUri": f"gpt://{config['catalog_id']}/yandexgpt-lite/latest",
            "completionOptions": {
                "stream": False,
                "temperature": 0.0,
                "maxTokens": 2000
            },
            "messages": messages
        }
    
    try:
        response = requests.post(url, headers=headers, json=prompt)
        response.raise_for_status()
        result = response.json()

        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
        if "result" in result and "alternatives" in result["result"]:
            assistant_text = result["result"]["alternatives"][0]["message"]["text"]

            # –ü—ã—Ç–∞–µ–º—Å—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–≥–∏–π JSON: –ø–∞—Ä—Å–∏–º, —Ä–∞—Å–∫–æ–≤—ã—Ä–∏–≤–∞–µ–º –∫–∞–≤—ã—á–∫–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
            raw = assistant_text.strip()
            parsed = None
            # 1) –ø—Ä—è–º–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å
            try:
                parsed = json.loads(raw)
            except json.JSONDecodeError:
                parsed = None

            # 2) –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å –≤–Ω—É—Ç—Ä–∏-JSON ("{...}") ‚Äî —Ä–∞—Å–ø–∞—Ä—Å–∏–º –≤—Ç–æ—Ä–æ–π —Ä–∞–∑
            if isinstance(parsed, str):
                try:
                    parsed = json.loads(parsed)
                except json.JSONDecodeError:
                    parsed = None

            # 3) –µ—Å–ª–∏ –≤—Å—ë –µ—â—ë None ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –≤—ã—Ä–µ–∑–∞—Ç—å —Å–∞–º—ã–π –ø–æ—Ö–æ–∂–∏–π –Ω–∞ JSON –±–ª–æ–∫
            if parsed is None:
                match = re.search(r"\{[\s\S]*\}", raw)
                if match:
                    candidate = match.group(0)
                    try:
                        parsed = json.loads(candidate)
                    except json.JSONDecodeError:
                        parsed = None

            if parsed is None:
                # –∂—ë—Å—Ç–∫–∏–π —Ñ–æ–ª–±—ç–∫: –ø—É—Å—Ç—ã–µ –ø–æ–ª—è
                return json.dumps(empty_movie_object(), ensure_ascii=False, indent=2)

            # –£—Å–ø–µ—à–Ω–æ: –≤–µ—Ä–Ω—ë–º –∫—Ä–∞—Å–∏–≤–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON —Å—Ç—Ä–æ–∫–æ–π (–¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞)
            return json.dumps(parsed, ensure_ascii=False, indent=2)
        else:
            return json.dumps(empty_movie_object(), ensure_ascii=False, indent=2)
            
    except requests.exceptions.RequestException:
        return json.dumps(empty_movie_object(), ensure_ascii=False, indent=2)
    except Exception:
        return json.dumps(empty_movie_object(), ensure_ascii=False, indent=2)


def call_yandex_gpt(messages, temperature=0.7):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ Yandex GPT"""
    url = "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Api-Key {config['api_key']}"
    }

    prompt = {
        "modelUri": f"gpt://{config['catalog_id']}/yandexgpt/latest",
        "completionOptions": {
            "stream": False,
            "temperature": temperature,
            "maxTokens": 2000
        },
        "messages": messages
    }

    try:
        response = requests.post(url, headers=headers, json=prompt)
        response.raise_for_status()
        result = response.json()

        if "result" in result and "alternatives" in result["result"]:
            return result["result"]["alternatives"][0]["message"]["text"]
        else:
            return "–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç"
    except Exception as e:
        return f"–û—à–∏–±–∫–∞: {str(e)}"


def solve_direct(task):
    """–°–ø–æ—Å–æ–± 1: –ü—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π"""
    messages = [
        {"role": "system", "text": DIRECT_PROMPT},
        {"role": "user", "text": task}
    ]
    return call_yandex_gpt(messages)


def solve_step_by_step(task):
    """–°–ø–æ—Å–æ–± 2: –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ"""
    messages = [
        {"role": "system", "text": STEP_BY_STEP_PROMPT},
        {"role": "user", "text": task}
    ]
    return call_yandex_gpt(messages)


def solve_with_prompt_generator(task):
    """–°–ø–æ—Å–æ–± 3: –°–Ω–∞—á–∞–ª–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç, –∑–∞—Ç–µ–º —Ä–µ—à–∞–µ–º —Å –µ–≥–æ –ø–æ–º–æ—â—å—é"""
    # –®–∞–≥ 1: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    messages_generator = [
        {"role": "system", "text": PROMPT_GENERATOR_INSTRUCTION},
        {"role": "user", "text": f"–°–æ–∑–¥–∞–π –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ—à–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–∏:\n\n{task}"}
    ]
    generated_prompt = call_yandex_gpt(messages_generator)

    # –®–∞–≥ 2: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
    messages_solver = [
        {"role": "system", "text": generated_prompt},
        {"role": "user", "text": task}
    ]
    solution = call_yandex_gpt(messages_solver)

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏ –ø—Ä–æ–º–ø—Ç, –∏ —Ä–µ—à–µ–Ω–∏–µ
    return f"=== –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ô –ü–†–û–ú–ü–¢ ===\n{generated_prompt}\n\n=== –†–ï–®–ï–ù–ò–ï –° –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï–ú –ü–†–û–ú–ü–¢–ê ===\n{solution}"


def solve_with_expert_panel(task):
    """–°–ø–æ—Å–æ–± 4: –ì—Ä—É–ø–ø–∞ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤"""
    messages = [
        {"role": "system", "text": EXPERT_PANEL_PROMPT},
        {"role": "user", "text": task}
    ]
    return call_yandex_gpt(messages, temperature=0.8)


@app.route('/')
def index():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å —á–∞—Ç–æ–º"""
    return render_template('index.html')


@app.route('/chat', methods=['POST'])
def chat():
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞"""
    data = request.json
    user_message = data.get('message', '').strip()

    if not user_message:
        return jsonify({'error': '–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'}), 400

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    chat_history.append({
        "role": "user",
        "text": user_message
    })

    # –î–ï–ù–¨ 9: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≤–Ω–µ—à–Ω—é—é –ø–∞–º—è—Ç—å
    user_tokens = estimate_tokens(user_message)
    memory.save_message(current_session_id, "user", user_message, user_tokens)

    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –∞–≥–µ–Ω—Ç–∞
    assistant_response = get_agent_response(user_message)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
    chat_history.append({
        "role": "assistant",
        "text": assistant_response
    })

    # –î–ï–ù–¨ 9: –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –≤–Ω–µ—à–Ω—é—é –ø–∞–º—è—Ç—å
    assistant_tokens = estimate_tokens(assistant_response)
    memory.save_message(current_session_id, "assistant", assistant_response, assistant_tokens)

    return jsonify({
        'response': assistant_response
    })


@app.route('/recommend', methods=['POST'])
def recommend():
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –∞–≥–µ–Ω—Ç—É-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–æ—Ä—É"""
    data = request.json
    user_message = data.get('message', '').strip()

    if not user_message:
        return jsonify({'error': '–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'}), 400

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
    recommendation_history.append({
        "role": "user",
        "text": user_message
    })

    # –î–ï–ù–¨ 9: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≤–Ω–µ—à–Ω—é—é –ø–∞–º—è—Ç—å
    user_tokens = estimate_tokens(user_message)
    memory.save_message(current_session_id, "user", f"[–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è] {user_message}", user_tokens)

    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –∞–≥–µ–Ω—Ç–∞-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–æ—Ä–∞
    assistant_response = get_recommendation_agent_response(user_message)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
    recommendation_history.append({
        "role": "assistant",
        "text": assistant_response
    })

    # –î–ï–ù–¨ 9: –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –≤–Ω–µ—à–Ω—é—é –ø–∞–º—è—Ç—å
    assistant_tokens = estimate_tokens(assistant_response)
    memory.save_message(current_session_id, "assistant", f"[–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è] {assistant_response[:100]}...", assistant_tokens)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç JSON (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è)
    try:
        # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
        json.loads(assistant_response)
        is_final_recommendation = True
    except json.JSONDecodeError:
        is_final_recommendation = False

    return jsonify({
        'response': assistant_response,
        'is_final': is_final_recommendation
    })


@app.route('/clear', methods=['POST'])
def clear_history():
    """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞"""
    global chat_history, current_session_id

    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
    chat_history = []

    # –î–ï–ù–¨ 9: –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é, —á—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å
    old_session_id = current_session_id
    current_session_id = str(uuid.uuid4())
    memory.create_session(current_session_id, f'–°–µ—Å—Å–∏—è {datetime.now().strftime("%Y-%m-%d %H:%M")}')

    print(f"üóëÔ∏è –û—á–∏—â–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞. –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è: {current_session_id[:8]}...")

    return jsonify({
        'status': 'ok',
        'new_session_id': current_session_id
    })


@app.route('/get_chat_history', methods=['GET'])
def get_chat_history():
    """–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ–±—ã—á–Ω–æ–≥–æ —á–∞—Ç–∞ (—Ä–µ–∂–∏–º –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞)"""
    return jsonify({
        'status': 'ok',
        'history': chat_history
    })


@app.route('/get_recommendation_history', methods=['GET'])
def get_recommendation_history():
    """–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π"""
    return jsonify({
        'status': 'ok',
        'history': recommendation_history
    })


@app.route('/clear_recommendations', methods=['POST'])
def clear_recommendations():
    """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π"""
    global recommendation_history, current_session_id

    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
    recommendation_history = []

    # –î–ï–ù–¨ 9: –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é, —á—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å
    old_session_id = current_session_id
    current_session_id = str(uuid.uuid4())
    memory.create_session(current_session_id, f'–°–µ—Å—Å–∏—è {datetime.now().strftime("%Y-%m-%d %H:%M")}')

    print(f"üóëÔ∏è –û—á–∏—â–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è: {current_session_id[:8]}...")

    return jsonify({
        'status': 'ok',
        'new_session_id': current_session_id
    })


@app.route('/get_reasoning_history', methods=['GET'])
def get_reasoning_history():
    """–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π"""
    return jsonify({
        'status': 'ok',
        'history': reasoning_history
    })


@app.route('/clear_reasoning', methods=['POST'])
def clear_reasoning():
    """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π"""
    global reasoning_history, current_session_id

    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
    reasoning_history = []

    # –î–ï–ù–¨ 9: –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é, —á—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å
    old_session_id = current_session_id
    current_session_id = str(uuid.uuid4())
    memory.create_session(current_session_id, f'–°–µ—Å—Å–∏—è {datetime.now().strftime("%Y-%m-%d %H:%M")}')

    print(f"üóëÔ∏è –û—á–∏—â–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π. –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è: {current_session_id[:8]}...")

    return jsonify({
        'status': 'ok',
        'new_session_id': current_session_id
    })


@app.route('/reasoning', methods=['POST'])
def reasoning():
    """–†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è"""
    global reasoning_history

    data = request.json
    task = data.get('task', '').strip()
    method = data.get('method', 'all')  # all, direct, step_by_step, prompt_generator, expert_panel

    if not task:
        return jsonify({'error': '–ó–∞–¥–∞—á–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}), 400

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞—á—É –≤ –∏—Å—Ç–æ—Ä–∏—é —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π
    reasoning_history.append({
        "role": "user",
        "text": task,
        "method": method
    })

    # –î–ï–ù–¨ 9: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ–ø—Ä–æ—Å –≤ –ø–∞–º—è—Ç—å
    user_tokens = estimate_tokens(task)
    memory.save_message(current_session_id, "user", f"[–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ] {task}", user_tokens)

    results = {}

    try:
        if method == 'all' or method == 'direct':
            results['direct'] = solve_direct(task)

        if method == 'all' or method == 'step_by_step':
            results['step_by_step'] = solve_step_by_step(task)

        if method == 'all' or method == 'prompt_generator':
            results['prompt_generator'] = solve_with_prompt_generator(task)

        if method == 'all' or method == 'expert_panel':
            results['expert_panel'] = solve_with_expert_panel(task)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∏—Å—Ç–æ—Ä–∏—é —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π
        reasoning_history.append({
            "role": "assistant",
            "text": json.dumps(results, ensure_ascii=False),
            "method": method,
            "task": task
        })

        # –î–ï–ù–¨ 9: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ø–∞–º—è—Ç—å
        results_summary = f"–ú–µ—Ç–æ–¥: {method}, –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã"
        assistant_tokens = estimate_tokens(str(results))
        memory.save_message(current_session_id, "assistant", f"[–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ] {results_summary}", assistant_tokens)

        return jsonify({
            'task': task,
            'method': method,
            'results': results
        })

    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/temperature_experiment', methods=['POST'])
def temperature_experiment():
    """–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã"""
    data = request.json
    prompt = data.get('prompt', '').strip()

    if not prompt:
        return jsonify({'error': '–ó–∞–ø—Ä–æ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}), 400

    # –ó–Ω–∞—á–µ–Ω–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (0.0 - 1.0)
    temperatures = [0.0, 0.5, 1.0]
    results = {}

    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∑–∞–ø—Ä–æ—Å —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–º–∏
        for temp in temperatures:
            messages = [
                {"role": "user", "text": prompt}
            ]
            response = call_yandex_gpt(messages, temperature=temp)
            results[str(temp)] = response

        # –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        analysis = {
            'prompt': prompt,
            'temperatures': {
                '0.0': {
                    'response': results['0.0'],
                    'description': '–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å'
                },
                '0.5': {
                    'response': results['0.5'],
                    'description': '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º - —É–º–µ—Ä–µ–Ω–Ω–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ç–æ—á–Ω–æ—Å—Ç–∏'
                },
                '1.0': {
                    'response': results['1.0'],
                    'description': '–ö—Ä–µ–∞—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å'
                }
            },
            'recommendations': {
                '0.0': '–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è: —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, —Ç–æ—á–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π, –ø–µ—Ä–µ–≤–æ–¥–æ–≤',
                '0.5': '–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è: –æ–±—â–µ–Ω–∏—è, —Ä–∞—Å—Å–∫–∞–∑–æ–≤, –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, —Å–æ–≤–µ—Ç–æ–≤, –¥–µ–ª–æ–≤–æ–π –ø–µ—Ä–µ–ø–∏—Å–∫–∏',
                '1.0': '–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è: –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ–≥–æ –ø–∏—Å—å–º–∞, –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–π, —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤, –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π'
            }
        }

        return jsonify(analysis)

    except Exception as e:
        return jsonify({'error': str(e)}), 500


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤ (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞)
def estimate_tokens(text: str) -> int:
    """–ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤"""
    # –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: ~4 —Å–∏–º–≤–æ–ª–∞ = 1 —Ç–æ–∫–µ–Ω –¥–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
    # –î–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞: ~6 —Å–∏–º–≤–æ–ª–æ–≤ = 1 —Ç–æ–∫–µ–Ω
    words = text.split()
    chars = len(text)
    # –°—Ä–µ–¥–Ω–µ–µ –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏ –∏ —Å–∏–º–≤–æ–ª–∞–º–∏
    return max(len(words), chars // 5)


# –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏ Yandex Cloud
YANDEX_MODELS = {
    'yandexgpt-lite': {
        'uri': 'yandexgpt-lite/latest',
        'name': 'YandexGPT Lite',
        'description': '–õ–µ–≥–∫–æ–≤–µ—Å–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤',
        'pricing': {'input': 0.2, 'output': 0.6}  # —Ä—É–± –∑–∞ 1K —Ç–æ–∫–µ–Ω–æ–≤
    },
    'yandexgpt': {
        'uri': 'yandexgpt/latest',
        'name': 'YandexGPT',
        'description': '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –º–æ–¥–µ–ª—å —Å –±–∞–ª–∞–Ω—Å–æ–º –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏',
        'pricing': {'input': 0.4, 'output': 1.2}
    },
    'yandexgpt-32k': {
        'uri': 'yandexgpt-32k/rc',
        'name': 'YandexGPT 32K',
        'description': '–ú–æ–¥–µ–ª—å —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º',
        'pricing': {'input': 0.8, 'output': 2.4}
    },
    'summarization': {
        'uri': 'summarization/latest',
        'name': 'Summarization',
        'description': '–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏',
        'pricing': {'input': 0.4, 'output': 1.2}
    }
}


def call_yandex_model(model_key: str, prompt: str) -> Dict[str, Any]:
    """
    –í—ã–∑–æ–≤ –º–æ–¥–µ–ª–∏ Yandex Cloud —á–µ—Ä–µ–∑ Foundation Models API
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
    """
    if model_key not in YANDEX_MODELS:
        return {
            'success': False,
            'model': model_key,
            'error': f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –º–æ–¥–µ–ª—å: {model_key}",
            'metrics': {'response_time': 0}
        }

    model_info = YANDEX_MODELS[model_key]
    model_uri = model_info['uri']

    url = "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Api-Key {config['api_key']}"
    }

    payload = {
        "modelUri": f"gpt://{config['catalog_id']}/{model_uri}",
        "completionOptions": {
            "stream": False,
            "temperature": 0.7,
            "maxTokens": 8000  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç - –º–æ–¥–µ–ª—å –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞
        },
        "messages": [
            {"role": "user", "text": prompt}
        ]
    }

    start_time = time.time()

    try:
        response = requests.post(url, headers=headers, json=payload, timeout=180)  # –£–≤–µ–ª–∏—á–µ–Ω –¥–æ 3 –º–∏–Ω—É—Ç –¥–ª—è –±–æ–ª—å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        elapsed_time = time.time() - start_time

        if response.status_code == 200:
            result = response.json()

            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—Ç–∞
            generated_text = ""
            input_tokens = 0
            output_tokens = 0

            if "result" in result and "alternatives" in result["result"]:
                generated_text = result["result"]["alternatives"][0]["message"]["text"]

                # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ –æ—Ç–≤–µ—Ç–∞
                usage = result["result"].get("usage", {})
                # –Ø–≤–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ int, API –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–∫–∏
                input_tokens = int(usage.get("inputTextTokens", estimate_tokens(prompt)))
                output_tokens = int(usage.get("completionTokens", estimate_tokens(generated_text)))

            total_tokens = input_tokens + output_tokens

            # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ —Ä—É–±–ª—è—Ö
            pricing = model_info['pricing']
            cost_rub = (float(input_tokens) * pricing['input'] + float(output_tokens) * pricing['output']) / 1000

            return {
                'success': True,
                'model': model_key,
                'model_name': model_info['name'],
                'response': generated_text,
                'metrics': {
                    'response_time': float(round(elapsed_time, 3)),
                    'input_tokens': int(input_tokens),
                    'output_tokens': int(output_tokens),
                    'total_tokens': int(total_tokens),
                    'cost_rub': float(round(cost_rub, 4)),
                    'is_free': False
                }
            }
        else:
            return {
                'success': False,
                'model': model_key,
                'model_name': model_info['name'],
                'error': f"HTTP {response.status_code}: {response.text[:200]}",
                'metrics': {
                    'response_time': float(round(time.time() - start_time, 3))
                }
            }

    except Exception as e:
        return {
            'success': False,
            'model': model_key,
            'model_name': model_info.get('name', model_key),
            'error': str(e),
            'metrics': {
                'response_time': float(round(time.time() - start_time, 3))
            }
        }


@app.route('/token_test', methods=['POST'])
def token_test():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤"""
    data = request.json
    prompt = data.get('prompt', '').strip()
    test_type = data.get('test_type', 'short')  # short, long, extreme

    if not prompt:
        return jsonify({'error': '–ó–∞–ø—Ä–æ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}), 400

    # –û—Ü–µ–Ω–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∑–∞–ø—Ä–æ—Å–µ
    estimated_input_tokens = estimate_tokens(prompt)

    try:
        # –î–ª—è —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –ø—Ä–æ–±—É–µ–º –æ–±–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        if test_type == 'extreme':
            # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –±–∞–∑–æ–≤—É—é –º–æ–¥–µ–ª—å (–ª–∏–º–∏—Ç 8000 —Ç–æ–∫–µ–Ω–æ–≤)
            result_base = call_yandex_model('yandexgpt', prompt)
            # –ó–∞—Ç–µ–º –ø—Ä–æ–±—É–µ–º 32K –º–æ–¥–µ–ª—å (–ª–∏–º–∏—Ç 32000 —Ç–æ–∫–µ–Ω–æ–≤)
            result_32k = call_yandex_model('yandexgpt-32k', prompt)

            response_data = {
                'test_type': test_type,
                'prompt': prompt,
                'prompt_length': len(prompt),
                'estimated_input_tokens': estimated_input_tokens,
                'comparison_mode': True,
                'base_model': {
                    'model_key': 'yandexgpt',
                    'model_name': YANDEX_MODELS['yandexgpt']['name'],
                    'model_limit': 8000,
                    'result': result_base
                },
                'extended_model': {
                    'model_key': 'yandexgpt-32k',
                    'model_name': YANDEX_MODELS['yandexgpt-32k']['name'],
                    'model_limit': 32000,
                    'result': result_32k
                }
            }

            # –ê–Ω–∞–ª–∏–∑ –¥–ª—è –±–∞–∑–æ–≤–æ–π –º–æ–¥–µ–ª–∏
            if result_base['success']:
                actual_input = result_base['metrics']['input_tokens']
                response_data['base_model']['analysis'] = {
                    'within_limit': actual_input < 8000,
                    'limit_usage_percent': round((actual_input / 8000) * 100, 1)
                }
            else:
                response_data['base_model']['analysis'] = {
                    'within_limit': False,
                    'error': '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ API'
                }

            # –ê–Ω–∞–ª–∏–∑ –¥–ª—è 32K –º–æ–¥–µ–ª–∏
            if result_32k['success']:
                actual_input = result_32k['metrics']['input_tokens']
                response_data['extended_model']['analysis'] = {
                    'within_limit': actual_input < 32000,
                    'limit_usage_percent': round((actual_input / 32000) * 100, 1)
                }
            else:
                response_data['extended_model']['analysis'] = {
                    'within_limit': False,
                    'error': '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ API'
                }

            return jsonify(response_data)

        else:
            # –î–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –∏ –¥–ª–∏–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –º–æ–¥–µ–ª—å
            model_key = 'yandexgpt'
            result = call_yandex_model(model_key, prompt)

            # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            response_data = {
                'test_type': test_type,
                'prompt': prompt,
                'prompt_length': len(prompt),
                'estimated_input_tokens': estimated_input_tokens,
                'model_used': model_key,
                'model_name': YANDEX_MODELS[model_key]['name'],
                'model_limit': 8000,
                'comparison_mode': False,
                'result': result
            }

            # –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            if result['success']:
                actual_input_tokens = result['metrics']['input_tokens']
                actual_output_tokens = result['metrics']['output_tokens']
                total_tokens = result['metrics']['total_tokens']

                response_data['analysis'] = {
                    'within_limit': actual_input_tokens < response_data['model_limit'],
                    'token_efficiency': round((actual_output_tokens / actual_input_tokens) if actual_input_tokens > 0 else 0, 2),
                    'cost_per_token': round(result['metrics']['cost_rub'] / total_tokens, 6) if total_tokens > 0 else 0,
                    'response_quality': '–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ' if actual_output_tokens > 50 else '–ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç'
                }
            else:
                response_data['analysis'] = {
                    'within_limit': False,
                    'error_type': 'API Error' if 'HTTP' in result['error'] else 'Unknown Error'
                }

            return jsonify(response_data)

    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/model_comparison', methods=['POST'])
def model_comparison():
    """–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π Yandex AI —Å –∑–∞–º–µ—Ä–æ–º –º–µ—Ç—Ä–∏–∫"""
    data = request.json
    prompt = data.get('prompt', '').strip()
    models = data.get('models', [])

    if not prompt:
        return jsonify({'error': '–ó–∞–ø—Ä–æ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}), 400

    if not models or len(models) < 2:
        return jsonify({'error': '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 –º–æ–¥–µ–ª–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è'}), 400

    results = []

    try:
        # –í—ã–∑—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –º–æ–¥–µ–ª—å
        for model_key in models:
            result = call_yandex_model(model_key, prompt)
            results.append(result)

        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        successful_results = [r for r in results if r['success']]

        comparison = {
            'prompt': prompt,
            'models_compared': len(models),
            'successful_calls': len(successful_results),
            'results': results
        }

        if successful_results:
            # –ù–∞—Ö–æ–¥–∏–º —Å–∞–º—É—é –±—ã—Å—Ç—Ä—É—é –∏ –º–µ–¥–ª–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å
            fastest = min(successful_results, key=lambda x: x['metrics']['response_time'])
            slowest = max(successful_results, key=lambda x: x['metrics']['response_time'])

            # –ù–∞—Ö–æ–¥–∏–º –º–æ–¥–µ–ª—å —Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–æ–∫–µ–Ω–æ–≤
            most_concise = min(successful_results, key=lambda x: x['metrics']['output_tokens'])
            most_verbose = max(successful_results, key=lambda x: x['metrics']['output_tokens'])

            # –ù–∞—Ö–æ–¥–∏–º —Å–∞–º—É—é –¥–µ—à–µ–≤—É—é –∏ –¥–æ—Ä–æ–≥—É—é
            cheapest = min(successful_results, key=lambda x: x['metrics']['cost_rub'])
            most_expensive = max(successful_results, key=lambda x: x['metrics']['cost_rub'])

            comparison['analysis'] = {
                'fastest_model': fastest.get('model_name', fastest['model']),
                'fastest_time': fastest['metrics']['response_time'],
                'slowest_model': slowest.get('model_name', slowest['model']),
                'slowest_time': slowest['metrics']['response_time'],
                'most_concise_model': most_concise.get('model_name', most_concise['model']),
                'most_concise_tokens': most_concise['metrics']['output_tokens'],
                'most_verbose_model': most_verbose.get('model_name', most_verbose['model']),
                'most_verbose_tokens': most_verbose['metrics']['output_tokens'],
                'cheapest_model': cheapest.get('model_name', cheapest['model']),
                'cheapest_cost': cheapest['metrics']['cost_rub'],
                'most_expensive_model': most_expensive.get('model_name', most_expensive['model']),
                'most_expensive_cost': most_expensive['metrics']['cost_rub'],
                'avg_response_time': round(sum(r['metrics']['response_time'] for r in successful_results) / len(successful_results), 3),
                'avg_output_tokens': round(sum(r['metrics']['output_tokens'] for r in successful_results) / len(successful_results), 1),
                'avg_cost': round(sum(r['metrics']['cost_rub'] for r in successful_results) / len(successful_results), 4)
            }

        return jsonify(comparison)

    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/compression_test', methods=['POST'])
def compression_test():
    """
    –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –¥–∏–∞–ª–æ–≥–∞ (–î–µ–Ω—å 8).
    –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É –∞–≥–µ–Ω—Ç–∞ —Å –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π –∏ —Å–æ —Å–∂–∞—Ç–æ–π.
    """
    data = request.json
    message = data.get('message', '').strip()
    action = data.get('action', 'send')  # send, stats, clear, compare

    if action == 'clear':
        # –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
        dialog_manager.clear()
        return jsonify({
            'status': 'ok',
            'message': '–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞'
        })

    elif action == 'stats':
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        stats = dialog_manager.get_stats()
        return jsonify({
            'status': 'ok',
            'stats': stats
        })

    elif action == 'compare':
        # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π –∏ –±–µ–∑
        if not message:
            return jsonify({'error': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}), 400

        try:
            # –°–æ–∑–¥–∞–µ–º –¥–≤–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è —á–µ—Å—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            manager_with_compression = DialogHistoryManager(compression_threshold=10, use_compression=True)
            manager_without_compression = DialogHistoryManager(compression_threshold=10, use_compression=False)

            # –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –∏—Å—Ç–æ—Ä–∏—é –≤ –æ–±–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            for msg in dialog_manager.messages:
                manager_with_compression.add_message(msg['role'], msg['text'])
                manager_without_compression.add_message(msg['role'], msg['text'])

            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            manager_with_compression.add_message('user', message)
            manager_without_compression.add_message('user', message)

            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç—ã —Å –æ–±–æ–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏—Å—Ç–æ—Ä–∏–∏
            # –° –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π
            start_time = time.time()
            history_compressed = manager_with_compression.get_history_for_api(use_compressed=True)
            messages_compressed = [{"role": "user", "text": message}]
            if len(history_compressed) > 0:
                messages_compressed = history_compressed + [{"role": "user", "text": message}]

            response_compressed = call_yandex_gpt(messages_compressed, temperature=0.7)
            time_compressed = time.time() - start_time

            # –ë–µ–∑ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏
            start_time = time.time()
            history_full = manager_without_compression.get_history_for_api(use_compressed=False)
            messages_full = [{"role": "user", "text": message}]
            if len(history_full) > 0:
                messages_full = history_full + [{"role": "user", "text": message}]

            response_full = call_yandex_gpt(messages_full, temperature=0.7)
            time_full = time.time() - start_time

            # –ü–æ–¥—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤
            tokens_compressed_input = sum(estimate_tokens(msg['text']) for msg in messages_compressed)
            tokens_compressed_output = estimate_tokens(response_compressed)

            tokens_full_input = sum(estimate_tokens(msg['text']) for msg in messages_full)
            tokens_full_output = estimate_tokens(response_full)

            # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—ã YandexGPT)
            pricing = YANDEX_MODELS['yandexgpt']['pricing']
            cost_compressed = (tokens_compressed_input * pricing['input'] + tokens_compressed_output * pricing['output']) / 1000
            cost_full = (tokens_full_input * pricing['input'] + tokens_full_output * pricing['output']) / 1000

            # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞ –≤ –≥–ª–∞–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
            dialog_manager.add_message('user', message)
            dialog_manager.add_message('assistant', response_compressed)

            comparison_result = {
                'with_compression': {
                    'response': response_compressed,
                    'metrics': {
                        'response_time': round(time_compressed, 3),
                        'input_tokens': tokens_compressed_input,
                        'output_tokens': tokens_compressed_output,
                        'total_tokens': tokens_compressed_input + tokens_compressed_output,
                        'cost_rub': round(cost_compressed, 4),
                        'history_messages': len(messages_compressed) - 1  # –ú–∏–Ω—É—Å —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    }
                },
                'without_compression': {
                    'response': response_full,
                    'metrics': {
                        'response_time': round(time_full, 3),
                        'input_tokens': tokens_full_input,
                        'output_tokens': tokens_full_output,
                        'total_tokens': tokens_full_input + tokens_full_output,
                        'cost_rub': round(cost_full, 4),
                        'history_messages': len(messages_full) - 1  # –ú–∏–Ω—É—Å —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    }
                },
                'savings': {
                    'tokens_saved': tokens_full_input - tokens_compressed_input,
                    'tokens_saved_percent': round((1 - tokens_compressed_input / tokens_full_input) * 100, 2) if tokens_full_input > 0 else 0,
                    'cost_saved': round(cost_full - cost_compressed, 4),
                    'cost_saved_percent': round((1 - cost_compressed / cost_full) * 100, 2) if cost_full > 0 else 0,
                    'time_difference': round(time_full - time_compressed, 3)
                },
                'compression_stats': manager_with_compression.get_stats()
            }

            return jsonify({
                'status': 'ok',
                'comparison': comparison_result
            })

        except Exception as e:
            return jsonify({'error': str(e)}), 500

    elif action == 'run_test':
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏
        try:
            # –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º
            dialog_manager.clear()

            # –°–µ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
            test_messages = [
                "–†–∞—Å—Å–∫–∞–∂–∏ –æ Python",
                "–ß—Ç–æ —Ç–∞–∫–æ–µ Django?",
                "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Flask?",
                "–ß—Ç–æ —Ç–∞–∫–æ–µ FastAPI?",
                "–°—Ä–∞–≤–Ω–∏ Django –∏ Flask",
                "–ö–∞–∫–∏–µ –µ—Å—Ç—å ORM –¥–ª—è Python?",
                "–ß—Ç–æ —Ç–∞–∫–æ–µ SQLAlchemy?",
                "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç async/await?",
                "–ß—Ç–æ —Ç–∞–∫–æ–µ asyncio?",
                "–û–±—ä—è—Å–Ω–∏ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –≤ Python",
                "–ß—Ç–æ —Ç–∞–∫–æ–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã?",
                "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç yield?",
            ]

            total_tokens = 0
            total_cost = 0
            start_time_total = time.time()

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            for message in test_messages:
                # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                dialog_manager.add_message('user', message)

                # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è API
                history = dialog_manager.get_history_for_api()
                messages = history.copy()

                # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏
                response = call_yandex_gpt(messages, temperature=0.7)

                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
                dialog_manager.add_message('assistant', response)

                # –ü–æ–¥—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤
                input_tokens = sum(estimate_tokens(msg['text']) for msg in messages)
                output_tokens = estimate_tokens(response)
                total_tokens += input_tokens + output_tokens

                # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
                pricing = YANDEX_MODELS['yandexgpt']['pricing']
                cost = (input_tokens * pricing['input'] + output_tokens * pricing['output']) / 1000
                total_cost += cost

            total_time = time.time() - start_time_total

            # –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            final_stats = dialog_manager.get_stats()

            # –î–µ–ª–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
            test_question = "–ö–∞–∫–æ–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –ª—É—á—à–µ –≤—ã–±—Ä–∞—Ç—å –¥–ª—è –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏?"

            # –°–æ–∑–¥–∞–µ–º –¥–≤–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è —á–µ—Å—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            manager_with = DialogHistoryManager(compression_threshold=10, use_compression=True)
            manager_without = DialogHistoryManager(compression_threshold=10, use_compression=False)

            # –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –∏—Å—Ç–æ—Ä–∏—é
            for msg in dialog_manager.messages:
                manager_with.add_message(msg['role'], msg['text'])
                manager_without.add_message(msg['role'], msg['text'])

            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å
            manager_with.add_message('user', test_question)
            manager_without.add_message('user', test_question)

            # –° –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π
            start_time = time.time()
            history_compressed = manager_with.get_history_for_api(use_compressed=True)
            messages_compressed = history_compressed + [{"role": "user", "text": test_question}] if history_compressed else [{"role": "user", "text": test_question}]
            response_compressed = call_yandex_gpt(messages_compressed, temperature=0.7)
            time_compressed = time.time() - start_time

            # –ë–µ–∑ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏
            start_time = time.time()
            history_full = manager_without.get_history_for_api(use_compressed=False)
            messages_full = history_full + [{"role": "user", "text": test_question}] if history_full else [{"role": "user", "text": test_question}]
            response_full = call_yandex_gpt(messages_full, temperature=0.7)
            time_full = time.time() - start_time

            # –ü–æ–¥—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            tokens_compressed_input = sum(estimate_tokens(msg['text']) for msg in messages_compressed)
            tokens_compressed_output = estimate_tokens(response_compressed)
            tokens_full_input = sum(estimate_tokens(msg['text']) for msg in messages_full)
            tokens_full_output = estimate_tokens(response_full)

            # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
            pricing = YANDEX_MODELS['yandexgpt']['pricing']
            cost_compressed = (tokens_compressed_input * pricing['input'] + tokens_compressed_output * pricing['output']) / 1000
            cost_full = (tokens_full_input * pricing['input'] + tokens_full_output * pricing['output']) / 1000

            comparison_result = {
                'with_compression': {
                    'response': response_compressed,
                    'metrics': {
                        'response_time': round(time_compressed, 3),
                        'input_tokens': tokens_compressed_input,
                        'output_tokens': tokens_compressed_output,
                        'total_tokens': tokens_compressed_input + tokens_compressed_output,
                        'cost_rub': round(cost_compressed, 4),
                        'history_messages': len(messages_compressed) - 1
                    }
                },
                'without_compression': {
                    'response': response_full,
                    'metrics': {
                        'response_time': round(time_full, 3),
                        'input_tokens': tokens_full_input,
                        'output_tokens': tokens_full_output,
                        'total_tokens': tokens_full_input + tokens_full_output,
                        'cost_rub': round(cost_full, 4),
                        'history_messages': len(messages_full) - 1
                    }
                },
                'savings': {
                    'tokens_saved': tokens_full_input - tokens_compressed_input,
                    'tokens_saved_percent': round((1 - tokens_compressed_input / tokens_full_input) * 100, 2) if tokens_full_input > 0 else 0,
                    'cost_saved': round(cost_full - cost_compressed, 4),
                    'cost_saved_percent': round((1 - cost_compressed / cost_full) * 100, 2) if cost_full > 0 else 0,
                    'time_difference': round(time_full - time_compressed, 3)
                }
            }

            return jsonify({
                'status': 'ok',
                'messages_sent': len(test_messages),
                'total_time': round(total_time, 2),
                'total_tokens': total_tokens,
                'total_cost': round(total_cost, 4),
                'final_stats': final_stats,
                'comparison': comparison_result
            })

        except Exception as e:
            return jsonify({'error': str(e)}), 500

    elif action == 'send':
        # –û–±—ã—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π
        if not message:
            return jsonify({'error': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}), 400

        try:
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –ª–∏ –∫–æ–º–ø—Ä–µ—Å—Å–∏—è
            compression_triggered = dialog_manager.add_message('user', message)

            # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è API
            history = dialog_manager.get_history_for_api()

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è API
            messages = history.copy()

            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏
            start_time = time.time()
            response = call_yandex_gpt(messages, temperature=0.7)
            response_time = time.time() - start_time

            # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
            dialog_manager.add_message('assistant', response)

            # –ü–æ–¥—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤
            input_tokens = sum(estimate_tokens(msg['text']) for msg in messages)
            output_tokens = estimate_tokens(response)
            total_tokens = input_tokens + output_tokens

            # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
            pricing = YANDEX_MODELS['yandexgpt']['pricing']
            cost = (input_tokens * pricing['input'] + output_tokens * pricing['output']) / 1000

            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            stats = dialog_manager.get_stats()

            return jsonify({
                'status': 'ok',
                'response': response,
                'compression_triggered': compression_triggered,
                'metrics': {
                    'response_time': round(response_time, 3),
                    'input_tokens': input_tokens,
                    'output_tokens': output_tokens,
                    'total_tokens': total_tokens,
                    'cost_rub': round(cost, 4)
                },
                'compression_stats': stats
            })

        except Exception as e:
            return jsonify({'error': str(e)}), 500

    else:
        return jsonify({'error': f'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: {action}'}), 400


# ==================== –í–ù–ï–®–ù–Ø–Ø –ü–ê–ú–Ø–¢–¨ (–î–ï–ù–¨ 9) ====================

@app.route('/memory/sessions', methods=['GET', 'POST'])
def manage_sessions():
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ –¥–∏–∞–ª–æ–≥–æ–≤"""
    global current_session_id

    if request.method == 'GET':
        # –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π
        sessions = memory.list_sessions(limit=50)
        return jsonify({
            'status': 'ok',
            'current_session': current_session_id,
            'sessions': sessions
        })

    elif request.method == 'POST':
        # –°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Å–µ—Å—Å–∏—é
        data = request.json
        action = data.get('action', 'create')

        if action == 'create':
            # –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
            session_id = str(uuid.uuid4())
            title = data.get('title', f'–°–µ—Å—Å–∏—è {datetime.now().strftime("%Y-%m-%d %H:%M")}')
            metadata = data.get('metadata', {})

            if memory.create_session(session_id, title, metadata):
                current_session_id = session_id
                return jsonify({
                    'status': 'ok',
                    'session_id': session_id,
                    'message': '–°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞'
                })
            else:
                return jsonify({'error': '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é'}), 500

        elif action == 'switch':
            # –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é
            session_id = data.get('session_id')
            if not session_id:
                return jsonify({'error': 'session_id –Ω–µ —É–∫–∞–∑–∞–Ω'}), 400

            session = memory.get_session(session_id)
            if session:
                current_session_id = session_id
                # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π —Å–µ—Å—Å–∏–∏
                messages = memory.get_messages(session_id)
                return jsonify({
                    'status': 'ok',
                    'session': session,
                    'messages': messages,
                    'message': '–°–µ—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞'
                })
            else:
                return jsonify({'error': '–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}), 404

        elif action == 'delete':
            # –£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é
            session_id = data.get('session_id')
            if not session_id:
                return jsonify({'error': 'session_id –Ω–µ —É–∫–∞–∑–∞–Ω'}), 400

            if memory.delete_session(session_id):
                # –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
                if session_id == current_session_id:
                    current_session_id = str(uuid.uuid4())
                    memory.create_session(current_session_id, '–ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è')

                return jsonify({
                    'status': 'ok',
                    'message': '–°–µ—Å—Å–∏—è —É–¥–∞–ª–µ–Ω–∞',
                    'current_session': current_session_id
                })
            else:
                return jsonify({'error': '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é'}), 500


@app.route('/memory/messages', methods=['GET'])
def get_session_messages():
    """–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏"""
    limit = request.args.get('limit', type=int, default=None)
    messages = memory.get_messages(current_session_id, limit)

    return jsonify({
        'status': 'ok',
        'session_id': current_session_id,
        'count': len(messages),
        'messages': messages
    })


@app.route('/memory/memories', methods=['GET', 'POST', 'DELETE'])
def manage_memories():
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç—å—é"""

    if request.method == 'GET':
        # –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –ø–∞–º—è—Ç–∏ –∏–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        category = request.args.get('category')

        if category:
            memories_list = memory.get_memories_by_category(category)
        else:
            limit = request.args.get('limit', type=int, default=50)
            memories_list = memory.list_all_memories(limit)

        return jsonify({
            'status': 'ok',
            'count': len(memories_list),
            'memories': memories_list
        })

    elif request.method == 'POST':
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –ø–∞–º—è—Ç—å
        data = request.json
        key = data.get('key')
        value = data.get('value')
        category = data.get('category', 'general')
        importance = data.get('importance', 5)
        metadata = data.get('metadata')

        if not key or value is None:
            return jsonify({'error': 'key –∏ value –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã'}), 400

        if memory.save_memory(key, value, category, importance, metadata):
            return jsonify({
                'status': 'ok',
                'message': '–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –ø–∞–º—è—Ç—å'
            })
        else:
            return jsonify({'error': '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'}), 500

    elif request.method == 'DELETE':
        # –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ –ø–∞–º—è—Ç–∏
        data = request.json
        key = data.get('key')

        if not key:
            return jsonify({'error': 'key –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'}), 400

        if memory.delete_memory(key):
            return jsonify({
                'status': 'ok',
                'message': '–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞'
            })
        else:
            return jsonify({'error': '–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}), 404


@app.route('/memory/context', methods=['GET', 'POST', 'DELETE'])
def manage_context():
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Å–µ—Å—Å–∏–∏"""

    if request.method == 'GET':
        # –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        key = request.args.get('key')

        if key:
            value = memory.get_context(current_session_id, key)
            if value is not None:
                return jsonify({
                    'status': 'ok',
                    'key': key,
                    'value': value
                })
            else:
                return jsonify({'error': '–ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
        else:
            context = memory.get_all_context(current_session_id)
            return jsonify({
                'status': 'ok',
                'session_id': current_session_id,
                'context': context
            })

    elif request.method == 'POST':
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        data = request.json
        key = data.get('key')
        value = data.get('value')

        if not key or value is None:
            return jsonify({'error': 'key –∏ value –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã'}), 400

        if memory.save_context(current_session_id, key, value):
            return jsonify({
                'status': 'ok',
                'message': '–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω'
            })
        else:
            return jsonify({'error': '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'}), 500

    elif request.method == 'DELETE':
        # –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
        data = request.json
        key = data.get('key')  # –ï—Å–ª–∏ None - —É–¥–∞–ª–∏—Ç—Å—è –≤–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç

        if memory.delete_context(current_session_id, key):
            return jsonify({
                'status': 'ok',
                'message': '–ö–æ–Ω—Ç–µ–∫—Å—Ç —É–¥–∞–ª–µ–Ω'
            })
        else:
            return jsonify({'error': '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å'}), 404


@app.route('/memory/stats', methods=['GET'])
def memory_stats():
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏"""
    stats = memory.get_stats()

    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
    session = memory.get_session(current_session_id)
    message_count = memory.get_message_count(current_session_id)

    return jsonify({
        'status': 'ok',
        'stats': stats,
        'current_session': {
            'session_id': current_session_id,
            'info': session,
            'message_count': message_count
        }
    })


@app.route('/memory/test', methods=['POST'])
def memory_test():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø–∞–º—è—Ç–∏"""
    data = request.json
    action = data.get('action', 'full_test')

    try:
        if action == 'full_test':
            # –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –ø–∞–º—è—Ç–∏
            test_results = []

            # 1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
            test_session_id = f"test_{uuid.uuid4()}"
            result = memory.create_session(test_session_id, "–¢–µ—Å—Ç–æ–≤–∞—è —Å–µ—Å—Å–∏—è", {"test": True})
            test_results.append({
                'test': '–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏',
                'success': result
            })

            # 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
            message_saved = memory.save_message(test_session_id, "user", "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", 10)
            message_saved &= memory.save_message(test_session_id, "assistant", "–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞", 20)
            test_results.append({
                'test': '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π',
                'success': message_saved
            })

            # 3. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            messages = memory.get_messages(test_session_id)
            test_results.append({
                'test': '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π',
                'success': len(messages) == 2,
                'data': messages
            })

            # 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–º—è—Ç—å
            memory_saved = memory.save_memory(
                "test_fact",
                {"fact": "Python - –æ—Ç–ª–∏—á–Ω—ã–π —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è"},
                "test",
                8
            )
            test_results.append({
                'test': '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–º—è—Ç—å',
                'success': memory_saved
            })

            # 5. –ß—Ç–µ–Ω–∏–µ –∏–∑ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏
            fact = memory.get_memory("test_fact")
            test_results.append({
                'test': '–ß—Ç–µ–Ω–∏–µ –∏–∑ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏',
                'success': fact is not None,
                'data': fact
            })

            # 6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            context_saved = memory.save_context(test_session_id, "current_task", "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏")
            context_saved &= memory.save_context(test_session_id, "step", 1)
            test_results.append({
                'test': '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞',
                'success': context_saved
            })

            # 7. –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            context = memory.get_all_context(test_session_id)
            test_results.append({
                'test': '–ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞',
                'success': len(context) == 2,
                'data': context
            })

            # 8. –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            memory.delete_session(test_session_id)
            memory.delete_memory("test_fact")

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            stats = memory.get_stats()

            return jsonify({
                'status': 'ok',
                'test_results': test_results,
                'all_passed': all(r['success'] for r in test_results),
                'stats': stats
            })

        elif action == 'persistence_test':
            # –¢–µ—Å—Ç –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É "–∑–∞–ø—É—Å–∫–∞–º–∏"
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            test_key = f"persistence_test_{int(time.time())}"
            test_value = {
                "timestamp": datetime.now().isoformat(),
                "data": "–≠—Ç–æ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è"
            }

            memory.save_memory(test_key, test_value, "persistence_test", 10)

            # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å
            loaded_value = memory.get_memory(test_key)

            success = loaded_value is not None and loaded_value.get('data') == test_value['data']

            return jsonify({
                'status': 'ok',
                'test': '–¢–µ—Å—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏',
                'success': success,
                'saved': test_value,
                'loaded': loaded_value,
                'message': '–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ /memory/memories'
            })

    except Exception as e:
        return jsonify({
            'status': 'error',
            'error': str(e)
        }), 500


def restore_session_history():
    """
    –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø–∞–º—è—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    """
    global chat_history, recommendation_history, reasoning_history

    try:
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
        messages = memory.get_messages(current_session_id, limit=50)

        if messages:
            print(f"üìö –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ {len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –ë–î")

            # –°—á–µ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            chat_count = 0
            recommendation_count = 0
            reasoning_count = 0

            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
            for msg in messages:
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É
                content = msg['content']

                if content.startswith('[–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ]'):
                    # –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è
                    text = content.replace('[–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ] ', '')

                    # –î–ª—è user-—Å–æ–æ–±—â–µ–Ω–∏–π - —ç—Ç–æ –∑–∞–¥–∞—á–∞
                    if msg['role'] == 'user':
                        reasoning_history.append({
                            "role": "user",
                            "text": text,
                            "method": "all"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é, —Ç–æ—á–Ω—ã–π –º–µ—Ç–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ –º–æ–∂–µ–º
                        })
                    # –î–ª—è assistant-—Å–æ–æ–±—â–µ–Ω–∏–π - –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                    else:
                        # –ò–∑–≤–ª–µ–∫–∞–µ–º –º–µ—Ç–æ–¥ –∏–∑ —Ç–µ–∫—Å—Ç–∞ "–ú–µ—Ç–æ–¥: {method}, ..."
                        method_match = re.search(r'–ú–µ—Ç–æ–¥:\s*(\w+)', text)
                        method = method_match.group(1) if method_match else 'all'

                        reasoning_history.append({
                            "role": "assistant",
                            "text": text,
                            "method": method,
                            "restored": True  # –ü–æ–º–µ—Ç–∫–∞, —á—Ç–æ —ç—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        })
                    reasoning_count += 1

                elif content.startswith('[–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è]'):
                    # –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
                    recommendation_history.append({
                        "role": msg['role'],
                        "text": content.replace('[–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è] ', '')
                    })
                    recommendation_count += 1

                else:
                    # –û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–∞—Ç–∞
                    chat_history.append({
                        "role": msg['role'],
                        "text": content
                    })
                    chat_count += 1

            # –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
            if chat_count > 0:
                print(f"   üí¨ –ß–∞—Ç: {chat_count} —Å–æ–æ–±—â–µ–Ω–∏–π")
            if recommendation_count > 0:
                print(f"   üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: {recommendation_count} —Å–æ–æ–±—â–µ–Ω–∏–π")
            if reasoning_count > 0:
                print(f"   üß† –†–∞—Å—Å—É–∂–¥–µ–Ω–∏—è: {reasoning_count} —Å–æ–æ–±—â–µ–Ω–∏–π")
        else:
            print("üì≠ –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏")

    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏: {e}")


# ==================== MCP –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ (–î–ï–ù–¨ 10) ====================

@app.route('/mcp/tools', methods=['GET'])
def get_mcp_tools():
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä)"""
    try:
        tools = mcp_service.get_tools()
        return jsonify({
            'status': 'ok',
            'count': len(tools),
            'tools': tools,
            'server': 'local'
        })
    except Exception as e:
        return jsonify({
            'status': 'error',
            'error': str(e)
        }), 500


@app.route('/mcp/github/tools', methods=['GET'])
def get_github_mcp_tools():
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ GitHub MCP"""
    if not github_mcp_service:
        return jsonify({
            'status': 'error',
            'error': 'GitHub MCP –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ GITHUB_TOKEN'
        }), 503

    try:
        tools = github_mcp_service.get_tools()
        return jsonify({
            'status': 'ok',
            'count': len(tools),
            'tools': tools,
            'server': 'github'
        })
    except Exception as e:
        return jsonify({
            'status': 'error',
            'error': str(e)
        }), 500


@app.route('/mcp/call_tool', methods=['POST'])
def call_mcp_tool():
    """–í—ã–∑–≤–∞—Ç—å MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä)"""
    data = request.json
    tool_name = data.get('tool_name')
    arguments = data.get('arguments', {})

    if not tool_name:
        return jsonify({
            'status': 'error',
            'error': 'tool_name –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'
        }), 400

    try:
        result = mcp_service.call_tool(tool_name, arguments)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        if result.get('success'):
            memory.save_message(
                current_session_id,
                "user",
                f"[MCP] –í—ã–∑–æ–≤ {tool_name}: {json.dumps(arguments, ensure_ascii=False)}",
                estimate_tokens(str(arguments))
            )

            result_text = '\n'.join([c['text'] for c in result.get('content', [])])
            memory.save_message(
                current_session_id,
                "assistant",
                f"[MCP] –†–µ–∑—É–ª—å—Ç–∞—Ç {tool_name}: {result_text}",
                estimate_tokens(result_text)
            )

        return jsonify(result)
    except Exception as e:
        return jsonify({
            'status': 'error',
            'error': str(e),
            'success': False
        }), 500


@app.route('/mcp/github/call_tool', methods=['POST'])
def call_github_mcp_tool():
    """–í—ã–∑–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç GitHub MCP"""
    if not github_mcp_service:
        return jsonify({
            'status': 'error',
            'error': 'GitHub MCP –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ GITHUB_TOKEN'
        }), 503

    data = request.json
    tool_name = data.get('tool_name')
    arguments = data.get('arguments', {})

    if not tool_name:
        return jsonify({
            'status': 'error',
            'error': 'tool_name –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'
        }), 400

    try:
        result = github_mcp_service.call_tool(tool_name, arguments)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        if result.get('success'):
            memory.save_message(
                current_session_id,
                "user",
                f"[GitHub MCP] –í—ã–∑–æ–≤ {tool_name}: {json.dumps(arguments, ensure_ascii=False)}",
                estimate_tokens(str(arguments))
            )

            result_text = '\n'.join([c['text'] for c in result.get('content', [])])
            memory.save_message(
                current_session_id,
                "assistant",
                f"[GitHub MCP] –†–µ–∑—É–ª—å—Ç–∞—Ç {tool_name}: {result_text}",
                estimate_tokens(result_text)
            )

        return jsonify(result)
    except Exception as e:
        return jsonify({
            'status': 'error',
            'error': str(e),
            'success': False
        }), 500


if __name__ == '__main__':
    # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
    session = memory.get_session(current_session_id)
    if session:
        print(f"üîÑ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–µ—Å—Å–∏—é: {session['title']}")
        print(f"   ID: {current_session_id[:8]}...")
        print(f"   –°–æ–∑–¥–∞–Ω–∞: {session['created_at']}")

        # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –∏–∑ –ë–î
        restore_session_history()
    else:
        print(f"‚ú® –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è: {current_session_id[:8]}...")

    app.run(debug=True, host='0.0.0.0', port=5005)

