"""
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –≤–Ω–µ—à–Ω–µ–π –ø–∞–º—è—Ç–∏ (–î–µ–Ω—å 9)
"""
from memory_service import MemoryService
import uuid
import json

def test_memory_service():
    """–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –ø–∞–º—è—Ç–∏"""
    print("üß™ –¢–ï–°–¢ –í–ù–ï–®–ù–ï–ô –ü–ê–ú–Ø–¢–ò –ê–ì–ï–ù–¢–ê")
    print("=" * 60)

    # –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å –ø–∞–º—è—Ç–∏
    memory = MemoryService("test_memory.db")

    # –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
    print("\n1Ô∏è‚É£ –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏...")
    test_session_id = f"test_{uuid.uuid4()}"
    result = memory.create_session(test_session_id, "–¢–µ—Å—Ç–æ–≤–∞—è —Å–µ—Å—Å–∏—è", {"test": True})
    assert result == True, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é"
    print("   ‚úÖ –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ")

    # –¢–µ—Å—Ç 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
    print("\n2Ô∏è‚É£ –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π...")
    result1 = memory.save_message(test_session_id, "user", "–ü—Ä–∏–≤–µ—Ç, –∞–≥–µ–Ω—Ç!", 5)
    result2 = memory.save_message(test_session_id, "assistant", "–ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?", 8)
    assert result1 and result2, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è"
    print("   ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")

    # –¢–µ—Å—Ç 3: –ß—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
    print("\n3Ô∏è‚É£ –¢–µ—Å—Ç —á—Ç–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π...")
    messages = memory.get_messages(test_session_id)
    assert len(messages) == 2, f"–û–∂–∏–¥–∞–ª–æ—Å—å 2 —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–æ–ª—É—á–µ–Ω–æ {len(messages)}"
    assert messages[0]['role'] == 'user', "–ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç user"
    assert messages[1]['role'] == 'assistant', "–í—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç assistant"
    print(f"   ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π")
    print(f"      - {messages[0]['role']}: {messages[0]['content'][:30]}...")
    print(f"      - {messages[1]['role']}: {messages[1]['content'][:30]}...")

    # –¢–µ—Å—Ç 4: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–º—è—Ç—å
    print("\n4Ô∏è‚É£ –¢–µ—Å—Ç –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏...")
    test_data = {
        "name": "–ò–≤–∞–Ω",
        "age": 30,
        "interests": ["–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ò–ò", "Python"]
    }
    result = memory.save_memory("user_info", test_data, "user_info", 9)
    assert result == True, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–∞–º—è—Ç—å"
    print("   ‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–º—è—Ç—å")

    # –¢–µ—Å—Ç 5: –ß—Ç–µ–Ω–∏–µ –∏–∑ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏
    print("\n5Ô∏è‚É£ –¢–µ—Å—Ç —á—Ç–µ–Ω–∏—è –∏–∑ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏...")
    loaded_data = memory.get_memory("user_info")
    assert loaded_data is not None, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"
    assert loaded_data['name'] == "–ò–≤–∞–Ω", "–î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç"
    assert loaded_data['age'] == 30, "–í–æ–∑—Ä–∞—Å—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç"
    print("   ‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã")
    print(f"      - –ò–º—è: {loaded_data['name']}")
    print(f"      - –í–æ–∑—Ä–∞—Å—Ç: {loaded_data['age']}")
    print(f"      - –ò–Ω—Ç–µ—Ä–µ—Å—ã: {', '.join(loaded_data['interests'])}")

    # –¢–µ—Å—Ç 6: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    print("\n6Ô∏è‚É£ –¢–µ—Å—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞...")
    result1 = memory.save_context(test_session_id, "current_task", "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏")
    result2 = memory.save_context(test_session_id, "step", 3)
    assert result1 and result2, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç"
    print("   ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω")

    # –¢–µ—Å—Ç 7: –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    print("\n7Ô∏è‚É£ –¢–µ—Å—Ç —á—Ç–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞...")
    context = memory.get_all_context(test_session_id)
    assert len(context) == 2, f"–û–∂–∏–¥–∞–ª–æ—Å—å 2 –∑–∞–ø–∏—Å–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –ø–æ–ª—É—á–µ–Ω–æ {len(context)}"
    assert context['current_task'] == "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏", "–ó–∞–¥–∞—á–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç"
    assert context['step'] == 3, "–®–∞–≥ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç"
    print(f"   ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω: {context}")

    # –¢–µ—Å—Ç 8: –°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π
    print("\n8Ô∏è‚É£ –¢–µ—Å—Ç —Å–ø–∏—Å–∫–∞ —Å–µ—Å—Å–∏–π...")
    sessions = memory.list_sessions()
    assert len(sessions) > 0, "–ù–µ—Ç —Å–µ—Å—Å–∏–π –≤ —Å–ø–∏—Å–∫–µ"
    print(f"   ‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(sessions)} —Å–µ—Å—Å–∏–π")

    # –¢–µ—Å—Ç 9: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    print("\n9Ô∏è‚É£ –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...")
    stats = memory.get_stats()
    print(f"   ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:")
    print(f"      - –°–µ—Å—Å–∏–π: {stats['sessions']}")
    print(f"      - –°–æ–æ–±—â–µ–Ω–∏–π: {stats['messages']}")
    print(f"      - –ó–∞–ø–∏—Å–µ–π –ø–∞–º—è—Ç–∏: {stats['memories']}")
    print(f"      - –ö–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤: {stats['context_entries']}")
    print(f"      - –†–∞–∑–º–µ—Ä –ë–î: {stats['db_size_mb']} –ú–ë")

    # –¢–µ—Å—Ç 10: –ü–ï–†–°–ò–°–¢–ï–ù–¢–ù–û–°–¢–¨ - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
    print("\nüîü –¢–µ—Å—Ç –ü–ï–†–°–ò–°–¢–ï–ù–¢–ù–û–°–¢–ò (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç!)...")
    print("   üìù –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç...")
    persistence_key = f"persist_test_{int(uuid.uuid4().hex[:8], 16)}"
    persistence_value = "–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞!"
    memory.save_memory(persistence_key, persistence_value, "persistence_test", 10)

    # –°–æ–∑–¥–∞–µ–º –ù–û–í–´–ô —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞ (–∏–º–∏—Ç–∞—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞)
    print("   üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å (—Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä)...")
    memory2 = MemoryService("test_memory.db")

    # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    print("   üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏...")
    loaded_value = memory2.get_memory(persistence_key)

    assert loaded_value is not None, "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å!"
    assert loaded_value == persistence_value, "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –î–∞–Ω–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã!"
    print(f"   ‚úÖ –ü–ï–†–°–ò–°–¢–ï–ù–¢–ù–û–°–¢–¨ –†–ê–ë–û–¢–ê–ï–¢!")
    print(f"      - –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: '{persistence_value}'")
    print(f"      - –ó–∞–≥—Ä—É–∂–µ–Ω–æ: '{loaded_value}'")

    # –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    print("\nüßπ –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...")
    memory.delete_session(test_session_id)
    memory.delete_memory("user_info")
    memory.delete_memory(persistence_key)
    print("   ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã")

    print("\n" + "=" * 60)
    print("üéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!")
    print("=" * 60)
    print("\nüí° –í–Ω–µ—à–Ω—è—è –ø–∞–º—è—Ç—å –∞–≥–µ–Ω—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞:")
    print("   ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–π")
    print("   ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π")
    print("   ‚úÖ –î–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å (—Ñ–∞–∫—Ç—ã)")
    print("   ‚úÖ –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç")
    print("   ‚úÖ –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏")
    print("\nüóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: test_memory.db")

    return True

if __name__ == "__main__":
    try:
        test_memory_service()
    except Exception as e:
        print(f"\n‚ùå –û–®–ò–ë–ö–ê –¢–ï–°–¢–ê: {e}")
        import traceback
        traceback.print_exc()
        exit(1)
